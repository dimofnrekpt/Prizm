import { PrizmOverlayOutsidePlacement } from '../models';
import { EventBus, setWidthHeight } from '../utils';
import { PrizmOverlayAbstractPosition } from './position';
const HINT_DIRECTIONS = ['t', 'b', 'l', 'r', 'tl', 'bl', 'tr', 'br', 'lt', 'rt', 'lb', 'rb'];
export class PrizmOverlayRelativePosition extends PrizmOverlayAbstractPosition {
    constructor(config) {
        super();
        this.updateConfig({
            ...{
                element: null,
                placement: PrizmOverlayOutsidePlacement.TOP,
                autoReposition: false,
                width: 'auto',
                height: 'auto',
            },
            ...config,
        });
    }
    init(zid) {
        super.init(zid);
        if (this.config.autoReposition)
            this.listenDrag(this.zid);
    }
    getPositions(targetEl) {
        const s = this.getCoords(this.config.element);
        const h = this.getCoords(targetEl);
        let { width: w, height: ht } = this.config;
        w = setWidthHeight(s, h, 'width', w);
        ht = setWidthHeight(s, h, 'height', ht);
        const { pos, props } = this.calculatePos(this.config.placement, s, h);
        // Try to keep hint host within viewport.
        const { innerHeight, innerWidth } = window;
        const coord = {
            top: Math.min(Math.max(0, props.top), innerHeight - h.height),
            left: Math.min(Math.max(0, props.left), innerWidth - h.width),
        };
        return { ...this.round(coord), width: w, height: ht, extra: pos };
    }
    reCalc() {
        EventBus.send(this.zid, 'z_dynpos');
    }
    getCoords(elem) {
        return elem.getBoundingClientRect();
    }
    calc(placement, src, host) {
        const [main, sub] = placement.split('');
        const p = { left: 0, top: 0 };
        if ((main === 't' || main === 'b') && !sub) {
            p.left = src.left + (src.width - host.width) / 2;
        }
        if ((main === 't' || main === 'b') && sub) {
            p.left = src.left;
        }
        if ((main === 't' || main === 'b') && sub === 'r') {
            p.left = src.left + src.width - host.width;
        }
        if (main === 'l') {
            p.left = src.left - host.width;
        }
        if (main === 'r') {
            p.left = src.right;
        }
        if (main === 't') {
            p.top = src.top - host.height;
        }
        if (main === 'b') {
            p.top = src.top + src.height;
        }
        if (main === 'l' || main === 'r') {
            p.top = src.top + (src.height - host.height) / 2;
        }
        if (sub === 't' && (main === 'l' || main === 'r')) {
            p.top = src.top;
        }
        if (sub === 'b' && (main === 'l' || main === 'r')) {
            p.top = src.top + src.height - host.height;
        }
        return p;
    }
    calculatePos(pos, s, h) {
        const props = this.calc(pos, s, h);
        if (!this.config.autoReposition || !this.isOverflowed({ ...props, width: h.width, height: h.height })) {
            return { pos, props };
        }
        const fallback = this.oppositeDirection(pos);
        // First - check the opposite direction (for backward compatibility and most likely correct value),
        // if still overflows - check all available placements
        pos =
            [fallback, ...HINT_DIRECTIONS].find(direction => {
                // Already checked?
                if (direction === pos)
                    return false;
                const props = this.calc(direction, s, h);
                return !this.isOverflowed({ ...props, width: h.width, height: h.height });
            }) ?? fallback;
        return { pos, props: this.calc(pos, s, h) };
    }
    isOverflowed(props) {
        const { innerHeight, innerWidth } = window;
        props.bottom = props.top + props.height;
        props.right = props.left + props.width;
        return props.bottom > innerHeight || props.top < 0 || props.left < 0 || props.right > innerWidth;
    }
    oppositeDirection(current) {
        const index = HINT_DIRECTIONS.indexOf(current);
        const even = index % 2 === 0;
        return even ? HINT_DIRECTIONS[index + 1] : HINT_DIRECTIONS[index - 1];
    }
    round(props) {
        Object.keys(props).forEach(x => (props[x] = Math.round(props[x])));
        return props;
    }
    listenDrag(zid) {
        if (this.obs)
            this.obs.disconnect();
        this.obs = new MutationObserver(mutationsList => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes')
                    EventBus.send(zid, 'z_dynpos');
            }
        });
        this.obs.observe(this.config.element, {
            attributeFilter: ['style'],
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS1yZWxhdGl2ZS1wb3NpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9zcmMvbGliL21vZHVsZXMvb3ZlcmxheS9wb3NpdGlvbi9vdmVybGF5LXJlbGF0aXZlLXBvc2l0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSw0QkFBNEIsRUFBNEIsTUFBTSxXQUFXLENBQUM7QUFDbkYsT0FBTyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDcEQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sWUFBWSxDQUFDO0FBVzFELE1BQU0sZUFBZSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQVUsQ0FBQztBQUV0RyxNQUFNLE9BQU8sNEJBQTZCLFNBQVEsNEJBQWdFO0lBRWhILFlBQVksTUFBMEM7UUFDcEQsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsWUFBWSxDQUFDO1lBQ2hCLEdBQUc7Z0JBQ0QsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsU0FBUyxFQUFFLDRCQUE0QixDQUFDLEdBQUc7Z0JBQzNDLGNBQWMsRUFBRSxLQUFLO2dCQUNyQixLQUFLLEVBQUUsTUFBTTtnQkFDYixNQUFNLEVBQUUsTUFBTTthQUNmO1lBQ0QsR0FBRyxNQUFNO1NBQ1YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVlLElBQUksQ0FBQyxHQUFXO1FBQzlCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWM7WUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxH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QUcsSUFBSSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUM5QyxLQUFLLE1BQU0sUUFBUSxJQUFJLGFBQWEsRUFBRTtnQkFDcEMsSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLFlBQVk7b0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDcEU7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ3BDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQztTQUMzQixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcml6bU92ZXJsYXlPdXRzaWRlUGxhY2VtZW50LCBQcml6bU92ZXJsYXlQb3NpdGlvbk1ldGEgfSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgRXZlbnRCdXMsIHNldFdpZHRoSGVpZ2h0IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgUHJpem1PdmVybGF5QWJzdHJhY3RQb3NpdGlvbiB9IGZyb20gJy4vcG9zaXRpb24nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFByaXptT3ZlcmxheVJlbGF0aXZlUG9zaXRpb25Db25maWcge1xuICBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgcGxhY2VtZW50PzogUHJpem1PdmVybGF5T3V0c2lkZVBsYWNlbWVudDtcbiAgLy8gcmUtY2FsY3VsYXRlIHBvc2l0aW9uIG9uIHNjcm9sbCwgcmVzaXplXG4gIGF1dG9SZXBvc2l0aW9uPzogYm9vbGVhbjtcbiAgd2lkdGg/OiBzdHJpbmcgfCBudW1iZXI7XG4gIGhlaWdodD86IHN0cmluZyB8IG51bWJlcjtcbn1cblxuY29uc3QgSElOVF9ESVJFQ1RJT05TID0gWyd0JywgJ2InLCAnbCcsICdyJywgJ3RsJywgJ2JsJywgJ3RyJywgJ2JyJywgJ2x0JywgJ3J0JywgJ2xiJywgJ3JiJ10gYXMgY29uc3Q7XG5cbmV4cG9ydCBjbGFzcyBQcml6bU92ZXJsYXlSZWxhdGl2ZVBvc2l0aW9uIGV4dGVuZHMgUHJpem1PdmVybGF5QWJzdHJhY3RQb3NpdGlvbjxQcml6bU92ZXJsYXlSZWxhdGl2ZVBvc2l0aW9uQ29uZmlnPiB7XG4gIG9icyE6IE11dGF0aW9uT2JzZXJ2ZXI7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUHJpem1PdmVybGF5UmVsYXRpdmVQb3NpdGlvbkNvbmZpZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51cGRhdGVDb25maWcoe1xuICAgICAgLi4ue1xuICAgICAgICBlbGVtZW50OiBudWxsLFxuICAgICAgICBwbGFjZW1lbnQ6IFByaXptT3ZlcmxheU91dHNpZGVQbGFjZW1lbnQuVE9QLFxuICAgICAgICBhdXRvUmVwb3NpdGlvbjogZmFsc2UsXG4gICAgICAgIHdpZHRoOiAnYXV0bycsXG4gICAgICAgIGhlaWdodDogJ2F1dG8nLFxuICAgICAgfSxcbiAgICAgIC4uLmNvbmZpZyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBvdmVycmlkZSBpbml0KHppZDogc3RyaW5nKTogdm9pZCB7XG4gICAgc3VwZXIuaW5pdCh6aWQpO1xuICAgIGlmICh0aGlzLmNvbmZpZy5hdXRvUmVwb3NpdGlvbikgdGhpcy5saXN0ZW5EcmFnKHRoaXMuemlkKTtcbiAgfVxuXG4gIHB1YmxpYyBvdmVycmlkZSBnZXRQb3NpdGlvbnModGFyZ2V0RWw6IEhUTUxFbGVtZW50KTogUGljazxQcml6bU92ZXJsYXlQb3NpdGlvbk1ldGEsIGFueT4ge1xuICAgIGNvbnN0IHMgPSB0aGlzLmdldENvb3Jkcyh0aGlzLmNvbmZpZy5lbGVtZW50KTtcbiAgICBjb25zdCBoID0gdGhpcy5nZXRDb29yZHModGFyZ2V0RWwpO1xuICAgIGxldCB7IHdpZHRoOiB3LCBoZWlnaHQ6IGh0IH0gPSB0aGlzLmNvbmZpZztcblxuICAgIHcgPSBzZXRXaWR0aEhlaWdodChzLCBoLCAnd2lkdGgnLCB3IGFzIGFueSk7XG4gICAgaHQgPSBzZXRXaWR0aEhlaWdodChzLCBoLCAnaGVpZ2h0JywgaHQgYXMgYW55KTtcblxuICAgIGNvbnN0IHsgcG9zLCBwcm9wcyB9ID0gdGhpcy5jYWxjdWxhdGVQb3ModGhpcy5jb25maWcucGxhY2VtZW50IGFzIGFueSwgcywgaCk7XG5cbiAgICAvLyBUcnkgdG8ga2VlcCBoaW50IGhvc3Qgd2l0aGluIHZpZXdwb3J0LlxuICAgIGNvbnN0IHsgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGggfSA9IHdpbmRvdztcbiAgICBjb25zdCBjb29yZCA9IHtcbiAgICAgIHRvcDogTWF0aC5taW4oTWF0aC5tYXgoMCwgcHJvcHMudG9wKSwgaW5uZXJIZWlnaHQgLSBoLmhlaWdodCksXG4gICAgICBsZWZ0OiBNYXRoLm1pbihNYXRoLm1heCgwLCBwcm9wcy5sZWZ0KSwgaW5uZXJXaWR0aCAtIGgud2lkdGgpLFxuICAgIH07XG5cbiAgICByZXR1cm4geyAuLi50aGlzLnJvdW5kKGNvb3JkKSwgd2lkdGg6IHcsIGhlaWdodDogaHQsIGV4dHJhOiBwb3MgfTtcbiAgfVxuXG4gIHB1YmxpYyByZUNhbGMoKTogdm9pZCB7XG4gICAgRXZlbnRCdXMuc2VuZCh0aGlzLnppZCwgJ3pfZHlucG9zJyk7XG4gIH1cblxuICBwcml2YXRlIGdldENvb3JkcyhlbGVtOiBIVE1MRWxlbWVudCk6IERPTVJlY3Qge1xuICAgIHJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjKHBsYWNlbWVudDogUHJpem1PdmVybGF5T3V0c2lkZVBsYWNlbWVudCwgc3JjOiBhbnksIGhvc3Q6IGFueSk6IHsgbGVmdDogbnVtYmVyOyB0b3A6IG51bWJlciB9IHtcbiAgICBjb25zdCBbbWFpbiwgc3ViXSA9IHBsYWNlbWVudC5zcGxpdCgnJyk7XG4gICAgY29uc3QgcCA9IHsgbGVmdDogMCwgdG9wOiAwIH07XG4gICAgaWYgKChtYWluID09PSAndCcgfHwgbWFpbiA9PT0gJ2InKSAmJiAhc3ViKSB7XG4gICAgICBwLmxlZnQgPSBzcmMubGVmdCArIChzcmMud2lkdGggLSBob3N0LndpZHRoKSAvIDI7XG4gICAgfVxuXG4gICAgaWYgKChtYWluID09PSAndCcgfHwgbWFpbiA9PT0gJ2InKSAmJiBzdWIpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0O1xuICAgIH1cbiAgICBpZiAoKG1haW4gPT09ICd0JyB8fCBtYWluID09PSAnYicpICYmIHN1YiA9PT0gJ3InKSB7XG4gICAgICBwLmxlZnQgPSBzcmMubGVmdCArIHNyYy53aWR0aCAtIGhvc3Qud2lkdGg7XG4gICAgfVxuICAgIGlmIChtYWluID09PSAnbCcpIHtcbiAgICAgIHAubGVmdCA9IHNyYy5sZWZ0IC0gaG9zdC53aWR0aDtcbiAgICB9XG4gICAgaWYgKG1haW4gPT09ICdyJykge1xuICAgICAgcC5sZWZ0ID0gc3JjLnJpZ2h0O1xuICAgIH1cblxuICAgIGlmIChtYWluID09PSAndCcpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcCAtIGhvc3QuaGVpZ2h0O1xuICAgIH1cbiAgICBpZiAobWFpbiA9PT0gJ2InKSB7XG4gICAgICBwLnRvcCA9IHNyYy50b3AgKyBzcmMuaGVpZ2h0O1xuICAgIH1cbiAgICBpZiAobWFpbiA9PT0gJ2wnIHx8IG1haW4gPT09ICdyJykge1xuICAgICAgcC50b3AgPSBzcmMudG9wICsgKHNyYy5oZWlnaHQgLSBob3N0LmhlaWdodCkgLyAyO1xuICAgIH1cbiAgICBpZiAoc3ViID09PSAndCcgJiYgKG1haW4gPT09ICdsJyB8fCBtYWluID09PSAncicpKSB7XG4gICAgICBwLnRvcCA9IHNyYy50b3A7XG4gICAgfVxuICAgIGlmIChzdWIgPT09ICdiJyAmJiAobWFpbiA9PT0gJ2wnIHx8IG1haW4gPT09ICdyJykpIHtcbiAgICAgIHAudG9wID0gc3JjLnRvcCArIHNyYy5oZWlnaHQgLSBob3N0LmhlaWdodDtcbiAgICB9XG5cbiAgICByZXR1cm4gcDtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlUG9zKFxuICAgIHBvczogUHJpem1PdmVybGF5T3V0c2lkZVBsYWNlbWVudCxcbiAgICBzOiBhbnksXG4gICAgaDogYW55XG4gICk6IHsgcG9zOiBzdHJpbmc7IHByb3BzOiB7IGxlZnQ6IG51bWJlcjsgdG9wOiBudW1iZXIgfSB9IHtcbiAgICBjb25zdCBwcm9wcyA9IHRoaXMuY2FsYyhwb3MsIHMsIGgpO1xuXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRvUmVwb3NpdGlvbiB8fCAhdGhpcy5pc092ZXJmbG93ZWQoeyAuLi5wcm9wcywgd2lkdGg6IGgud2lkdGgsIGhlaWdodDogaC5oZWlnaHQgfSkpIHtcbiAgICAgIHJldHVybiB7IHBvcywgcHJvcHMgfTtcbiAgICB9XG5cbiAgICBjb25zdCBmYWxsYmFjayA9IHRoaXMub3Bwb3NpdGVEaXJlY3Rpb24ocG9zKTtcblxuICAgIC8vIEZpcnN0IC0gY2hlY2sgdGhlIG9wcG9zaXRlIGRpcmVjdGlvbiAoZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgYW5kIG1vc3QgbGlrZWx5IGNvcnJlY3QgdmFsdWUpLFxuICAgIC8vIGlmIHN0aWxsIG92ZXJmbG93cyAtIGNoZWNrIGFsbCBhdmFpbGFibGUgcGxhY2VtZW50c1xuICAgIHBvcyA9XG4gICAgICBbZmFsbGJhY2ssIC4uLkhJTlRfRElSRUNUSU9OU10uZmluZChkaXJlY3Rpb24gPT4ge1xuICAgICAgICAvLyBBbHJlYWR5IGNoZWNrZWQ/XG4gICAgICAgIGlmIChkaXJlY3Rpb24gPT09IHBvcykgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy5jYWxjKGRpcmVjdGlvbiwgcywgaCk7XG4gICAgICAgIHJldHVybiAhdGhpcy5pc092ZXJmbG93ZWQoeyAuLi5wcm9wcywgd2lkdGg6IGgud2lkdGgsIGhlaWdodDogaC5oZWlnaHQgfSk7XG4gICAgICB9KSA/PyBmYWxsYmFjaztcblxuICAgIHJldHVybiB7IHBvcywgcHJvcHM6IHRoaXMuY2FsYyhwb3MsIHMsIGgpIH07XG4gIH1cblxuICBwcml2YXRlIGlzT3ZlcmZsb3dlZChwcm9wczogeyBbeDogc3RyaW5nXTogYW55IH0pOiBib29sZWFuIHtcbiAgICBjb25zdCB7IGlubmVySGVpZ2h0LCBpbm5lcldpZHRoIH0gPSB3aW5kb3c7XG5cbiAgICBwcm9wcy5ib3R0b20gPSBwcm9wcy50b3AgKyBwcm9wcy5oZWlnaHQ7XG4gICAgcHJvcHMucmlnaHQgPSBwcm9wcy5sZWZ0ICsgcHJvcHMud2lkdGg7XG5cbiAgICByZXR1cm4gcHJvcHMuYm90dG9tID4gaW5uZXJIZWlnaHQgfHwgcHJvcHMudG9wIDwgMCB8fCBwcm9wcy5sZWZ0IDwgMCB8fCBwcm9wcy5yaWdodCA+IGlubmVyV2lkdGg7XG4gIH1cblxuICBwcml2YXRlIG9wcG9zaXRlRGlyZWN0aW9uKGN1cnJlbnQ6IFByaXptT3ZlcmxheU91dHNpZGVQbGFjZW1lbnQpOiBhbnkge1xuICAgIGNvbnN0IGluZGV4ID0gSElOVF9ESVJFQ1RJT05TLmluZGV4T2YoY3VycmVudCk7XG4gICAgY29uc3QgZXZlbiA9IGluZGV4ICUgMiA9PT0gMDtcblxuICAgIHJldHVybiBldmVuID8gSElOVF9ESVJFQ1RJT05TW2luZGV4ICsgMV0gOiBISU5UX0RJUkVDVElPTlNbaW5kZXggLSAxXTtcbiAgfVxuXG4gIHByaXZhdGUgcm91bmQocHJvcHM6IFJlY29yZDxzdHJpbmcsIGFueT4pOiB0eXBlb2YgcHJvcHMge1xuICAgIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKHggPT4gKHByb3BzW3hdID0gTWF0aC5yb3VuZChwcm9wc1t4XSkpKTtcbiAgICByZXR1cm4gcHJvcHM7XG4gIH1cblxuICBwcml2YXRlIGxpc3RlbkRyYWcoemlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vYnMpIHRoaXMub2JzLmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLm9icyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKG11dGF0aW9uc0xpc3QgPT4ge1xuICAgICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbnNMaXN0KSB7XG4gICAgICAgIGlmIChtdXRhdGlvbi50eXBlID09PSAnYXR0cmlidXRlcycpIEV2ZW50QnVzLnNlbmQoemlkLCAnel9keW5wb3MnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMub2JzLm9ic2VydmUodGhpcy5jb25maWcuZWxlbWVudCwge1xuICAgICAgYXR0cmlidXRlRmlsdGVyOiBbJ3N0eWxlJ10sXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==