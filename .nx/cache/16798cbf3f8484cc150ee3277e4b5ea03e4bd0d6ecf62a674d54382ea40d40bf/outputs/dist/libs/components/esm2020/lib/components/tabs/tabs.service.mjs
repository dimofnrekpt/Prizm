import { Injectable } from '@angular/core';
import { BehaviorSubject, combineLatest, concat, of, Subject } from 'rxjs';
import { distinctUntilChanged, map, take, takeUntil, tap } from 'rxjs/operators';
import { filterTruthy, PrizmDestroyService, prizmFromMutationObserver$ } from '@prizm-ui/helpers';
import * as i0 from "@angular/core";
import * as i1 from "@prizm-ui/helpers";
export class PrizmTabsService {
    get changeParent$() {
        return this.changeParent$_;
    }
    get activeTabIdx() {
        return this.activeTabIdx$$.value;
    }
    get tabs$() {
        return concat(of(this.tabs), this.changes$$);
    }
    constructor(destroy) {
        this.destroy = destroy;
        this.tabs = new Map();
        this.changes$$ = new Subject();
        this.removed$$ = new Subject();
        this.closeTab$$ = new Subject();
        this.activeTabIdx$$ = new BehaviorSubject(0);
        this.activeTabIdx$ = this.activeTabIdx$$.pipe(distinctUntilChanged());
        this.canOpenTab = null;
    }
    initObservingTabsParent(el) {
        this.changeParent$_ = prizmFromMutationObserver$(el, {
            subtree: true,
            childList: true,
        });
    }
    isActiveTab(tab) {
        return combineLatest([this.activeTabIdx$$, this.tabs$]).pipe(map(([activeTabIdx]) => {
            const tabIdx = this.findTabIdx(tab);
            return activeTabIdx === tabIdx;
        }), distinctUntilChanged());
    }
    getTabByIdx(idx) {
        return this.tabs.get(idx);
    }
    moveTab(idx, toIndex, tab) {
        if (tab !== this.getTabByIdx(idx))
            return;
        this.tabs.delete(idx);
        this.updateTab(tab, toIndex);
        if (this.activeTabIdx$$.value === idx) {
            this.activeTabIdx$$.next(toIndex);
        }
    }
    updateTab(tab, idx) {
        const tabIdx = typeof idx !== 'number' ? this.tabs.size : idx;
        if (this.tabs.get(tabIdx) === tab)
            return;
        this.tabs.set(tabIdx, tab);
        this.changes$$.next(this.tabs);
    }
    removeTab(tab) {
        const idx = this.findTabIdx(tab);
        this.tabs.delete(idx);
        this.removed$$.next(tab);
        const newIdx = this.correctActiveTabIdx(idx);
        if (idx !== newIdx)
            this.changes$$.next(this.tabs);
    }
    correctActiveTabIdx(idx = this.activeTabIdx$$.value) {
        if (this.tabs.has(this.activeTabIdx$$.value))
            return this.activeTabIdx$$.value;
        if (!this.tabs.size)
            return -1;
        const indexes = Array.from(this.tabs.keys()).sort();
        const nextIdx = indexes.find(i => i > idx);
        const newIdx = nextIdx ?? indexes.pop();
        this.activeTabIdx$$.next(newIdx);
        return newIdx;
    }
    findTabIdx(tab) {
        return Array.from(this.tabs.entries()).find(([, t]) => t === tab)?.[0] ?? -1;
    }
    selectTab(tab) {
        const idx = this.findTabIdx(tab);
        if (idx === -1) {
            return;
        }
        this.selectTabIfCanOpen(tab, idx);
    }
    selectTabIfCanOpen(tab, idx) {
        if (idx === this.activeTabIdx) {
            return;
        }
        (typeof this.canOpenTab === 'function' ? this.canOpenTab(tab) : of(true))
            .pipe(take(1), filterTruthy(), tap(() => this.activeTabIdx$$.next(idx)), takeUntil(this.destroy))
            .subscribe();
    }
    ngOnDestroy() {
        this.closeTab$$.complete();
        this.closeTab$$.unsubscribe();
        this.activeTabIdx$$.complete();
        this.activeTabIdx$$.unsubscribe();
        this.changes$$.unsubscribe();
        this.changes$$.unsubscribe();
    }
    updateActiveTab(idx) {
        this.activeTabIdx$$.next(idx);
    }
}
PrizmTabsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PrizmTabsService, deps: [{ token: i1.PrizmDestroyService }], target: i0.ɵɵFactoryTarget.Injectable });
PrizmTabsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PrizmTabsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PrizmTabsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.PrizmDestroyService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFicy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9jb21wb25lbnRzL3NyYy9saWIvY29tcG9uZW50cy90YWJzL3RhYnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxvQkFBb0IsRUFBVSxHQUFHLEVBQWEsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRyxPQUFPLEVBQUUsWUFBWSxFQUFFLG1CQUFtQixFQUFFLDBCQUEwQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7OztBQUlsRyxNQUFNLE9BQU8sZ0JBQWdCO0lBSzNCLElBQUksYUFBYTtRQUNmLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBS0QsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQztJQUNuQyxDQUFDO0lBQ0QsSUFBSSxLQUFLO1FBQ1AsT0FBTyxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUdELFlBQTZCLE9BQTRCO1FBQTVCLFlBQU8sR0FBUCxPQUFPLENBQXFCO1FBbkJoRCxTQUFJLEdBQUcsSUFBSSxHQUFHLEVBQTZCLENBQUM7UUFDNUMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFrQyxDQUFDO1FBQzFELGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBcUIsQ0FBQztRQUs3QyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQWtDLENBQUM7UUFDbkQsbUJBQWMs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QyxPQUFPLElBQUksQ0FBQyxVQUFVLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdEUsSUFBSSxDQUNILElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxZQUFZLEVBQUUsRUFDZCxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDeEMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FDeEI7YUFDQSxTQUFTLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFTSxlQUFlLENBQUMsR0FBVztRQUNoQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQyxDQUFDOzs2R0FoSFUsZ0JBQWdCO2lIQUFoQixnQkFBZ0I7MkZBQWhCLGdCQUFnQjtrQkFENUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBjb25jYXQsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIHN0YXJ0V2l0aCwgdGFrZSwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQcml6bVRhYkNvbXBvbmVudCB9IGZyb20gJy4vY29tcG9uZW50cy90YWIuY29tcG9uZW50JztcbmltcG9ydCB7IGZpbHRlclRydXRoeSwgUHJpem1EZXN0cm95U2VydmljZSwgcHJpem1Gcm9tTXV0YXRpb25PYnNlcnZlciQgfSBmcm9tICdAcHJpem0tdWkvaGVscGVycyc7XG5pbXBvcnQgeyBQcml6bVRhYkNhbk9wZW4gfSBmcm9tICcuL3RhYnMubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUHJpem1UYWJzU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHJlYWRvbmx5IHRhYnMgPSBuZXcgTWFwPG51bWJlciwgUHJpem1UYWJDb21wb25lbnQ+KCk7XG4gIHJlYWRvbmx5IGNoYW5nZXMkJCA9IG5ldyBTdWJqZWN0PE1hcDxudW1iZXIsIFByaXptVGFiQ29tcG9uZW50Pj4oKTtcbiAgcmVhZG9ubHkgcmVtb3ZlZCQkID0gbmV3IFN1YmplY3Q8UHJpem1UYWJDb21wb25lbnQ+KCk7XG4gIHByaXZhdGUgY2hhbmdlUGFyZW50JF8hOiBPYnNlcnZhYmxlPGFueT47XG4gIGdldCBjaGFuZ2VQYXJlbnQkKCkge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZVBhcmVudCRfO1xuICB9XG4gIHJlYWRvbmx5IGNsb3NlVGFiJCQgPSBuZXcgU3ViamVjdDxNYXA8bnVtYmVyLCBQcml6bVRhYkNvbXBvbmVudD4+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgYWN0aXZlVGFiSWR4JCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlcj4oMCk7XG4gIHJlYWRvbmx5IGFjdGl2ZVRhYklkeCQgPSB0aGlzLmFjdGl2ZVRhYklkeCQkLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG5cbiAgZ2V0IGFjdGl2ZVRhYklkeCgpIHtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVUYWJJZHgkJC52YWx1ZTtcbiAgfVxuICBnZXQgdGFicyQoKSB7XG4gICAgcmV0dXJuIGNvbmNhdChvZih0aGlzLnRhYnMpLCB0aGlzLmNoYW5nZXMkJCk7XG4gIH1cbiAgcHVibGljIGNhbk9wZW5UYWI6IFByaXptVGFiQ2FuT3BlbiB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveTogUHJpem1EZXN0cm95U2VydmljZSkge31cblxuICBwdWJsaWMgaW5pdE9ic2VydmluZ1RhYnNQYXJlbnQoZWw6IEhUTUxFbGVtZW50KSB7XG4gICAgdGhpcy5jaGFuZ2VQYXJlbnQkXyA9IHByaXptRnJvbU11dGF0aW9uT2JzZXJ2ZXIkKGVsLCB7XG4gICAgICBzdWJ0cmVlOiB0cnVlLFxuICAgICAgY2hpbGRMaXN0OiB0cnVlLFxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBpc0FjdGl2ZVRhYih0YWI6IFByaXptVGFiQ29tcG9uZW50KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3RoaXMuYWN0aXZlVGFiSWR4JCQsIHRoaXMudGFicyRdKS5waXBlKFxuICAgICAgbWFwKChbYWN0aXZlVGFiSWR4XSkgPT4ge1xuICAgICAgICBjb25zdCB0YWJJZHggPSB0aGlzLmZpbmRUYWJJZHgodGFiKTtcbiAgICAgICAgcmV0dXJuIGFjdGl2ZVRhYklkeCA9PT0gdGFiSWR4O1xuICAgICAgfSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWJCeUlkeChpZHg6IG51bWJlcik6IFByaXptVGFiQ29tcG9uZW50IHtcbiAgICByZXR1cm4gdGhpcy50YWJzLmdldChpZHgpIGFzIFByaXptVGFiQ29tcG9uZW50O1xuICB9XG5cbiAgcHVibGljIG1vdmVUYWIoaWR4OiBudW1iZXIsIHRvSW5kZXg6IG51bWJlciwgdGFiOiBQcml6bVRhYkNvbXBvbmVudCk6IHZvaWQge1xuICAgIGlmICh0YWIgIT09IHRoaXMuZ2V0VGFiQnlJZHgoaWR4KSkgcmV0dXJuO1xuICAgIHRoaXMudGFicy5kZWxldGUoaWR4KTtcbiAgICB0aGlzLnVwZGF0ZVRhYih0YWIsIHRvSW5kZXgpO1xuICAgIGlmICh0aGlzLmFjdGl2ZVRhYklkeCQkLnZhbHVlID09PSBpZHgpIHtcbiAgICAgIHRoaXMuYWN0aXZlVGFiSWR4JCQubmV4dCh0b0luZGV4KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlVGFiKHRhYjogUHJpem1UYWJDb21wb25lbnQsIGlkeD86IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHRhYklkeCA9IHR5cGVvZiBpZHggIT09ICdudW1iZXInID8gdGhpcy50YWJzLnNpemUgOiBpZHg7XG4gICAgaWYgKHRoaXMudGFicy5nZXQodGFiSWR4KSA9PT0gdGFiKSByZXR1cm47XG4gICAgdGhpcy50YWJzLnNldCh0YWJJZHgsIHRhYik7XG4gICAgdGhpcy5jaGFuZ2VzJCQubmV4dCh0aGlzLnRhYnMpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZVRhYih0YWI6IFByaXptVGFiQ29tcG9uZW50KTogdm9pZCB7XG4gICAgY29uc3QgaWR4ID0gdGhpcy5maW5kVGFiSWR4KHRhYik7XG4gICAgdGhpcy50YWJzLmRlbGV0ZShpZHgpO1xuICAgIHRoaXMucmVtb3ZlZCQkLm5leHQodGFiKTtcbiAgICBjb25zdCBuZXdJZHggPSB0aGlzLmNvcnJlY3RBY3RpdmVUYWJJZHgoaWR4KTtcbiAgICBpZiAoaWR4ICE9PSBuZXdJZHgpIHRoaXMuY2hhbmdlcyQkLm5leHQodGhpcy50YWJzKTtcbiAgfVxuXG4gIHByaXZhdGUgY29ycmVjdEFjdGl2ZVRhYklkeChpZHg6IG51bWJlciA9IHRoaXMuYWN0aXZlVGFiSWR4JCQudmFsdWUpOiBudW1iZXIge1xuICAgIGlmICh0aGlzLnRhYnMuaGFzKHRoaXMuYWN0aXZlVGFiSWR4JCQudmFsdWUpKSByZXR1cm4gdGhpcy5hY3RpdmVUYWJJZHgkJC52YWx1ZTtcbiAgICBpZiAoIXRoaXMudGFicy5zaXplKSByZXR1cm4gLTE7XG4gICAgY29uc3QgaW5kZXhlcyA9IEFycmF5LmZyb20odGhpcy50YWJzLmtleXMoKSkuc29ydCgpO1xuICAgIGNvbnN0IG5leHRJZHggPSBpbmRleGVzLmZpbmQoaSA9PiBpID4gaWR4KTtcbiAgICBjb25zdCBuZXdJZHggPSBuZXh0SWR4ID8/IChpbmRleGVzLnBvcCgpIGFzIG51bWJlcik7XG4gICAgdGhpcy5hY3RpdmVUYWJJZHgkJC5uZXh0KG5ld0lkeCk7XG4gICAgcmV0dXJuIG5ld0lkeDtcbiAgfVxuICBwdWJsaWMgZmluZFRhYklkeCh0YWI6IFByaXptVGFiQ29tcG9uZW50KTogbnVtYmVyIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnRhYnMuZW50cmllcygpKS5maW5kKChbLCB0XSkgPT4gdCA9PT0gdGFiKT8uWzBdID8/IC0xO1xuICB9XG4gIHB1YmxpYyBzZWxlY3RUYWIodGFiOiBQcml6bVRhYkNvbXBvbmVudCk6IHZvaWQge1xuICAgIGNvbnN0IGlkeCA9IHRoaXMuZmluZFRhYklkeCh0YWIpO1xuXG4gICAgaWYgKGlkeCA9PT0gLTEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zZWxlY3RUYWJJZkNhbk9wZW4odGFiLCBpZHgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RUYWJJZkNhbk9wZW4odGFiOiBQcml6bVRhYkNvbXBvbmVudCwgaWR4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAoaWR4ID09PSB0aGlzLmFjdGl2ZVRhYklkeCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAodHlwZW9mIHRoaXMuY2FuT3BlblRhYiA9PT0gJ2Z1bmN0aW9uJyA/IHRoaXMuY2FuT3BlblRhYih0YWIpIDogb2YodHJ1ZSkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgZmlsdGVyVHJ1dGh5KCksXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmFjdGl2ZVRhYklkeCQkLm5leHQoaWR4KSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNsb3NlVGFiJCQuY29tcGxldGUoKTtcbiAgICB0aGlzLmNsb3NlVGFiJCQudW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmFjdGl2ZVRhYklkeCQkLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5hY3RpdmVUYWJJZHgkJC51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuY2hhbmdlcyQkLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5jaGFuZ2VzJCQudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVBY3RpdmVUYWIoaWR4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2ZVRhYklkeCQkLm5leHQoaWR4KTtcbiAgfVxufVxuIl19