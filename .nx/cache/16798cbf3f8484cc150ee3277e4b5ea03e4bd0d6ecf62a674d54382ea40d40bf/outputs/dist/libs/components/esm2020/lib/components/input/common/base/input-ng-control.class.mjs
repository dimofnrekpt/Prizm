import { ChangeDetectorRef, Directive, ElementRef, inject, Injector } from '@angular/core';
import { NgControl, NgModel, Validators } from '@angular/forms';
import { PrizmInputControl } from './input-control.class';
import { PrizmDestroyService } from '@prizm-ui/helpers';
import { map, takeUntil, tap } from 'rxjs/operators';
import { PrizmInputLayoutComponent } from '../input-layout';
import { BehaviorSubject, fromEvent, merge } from 'rxjs';
import { PRIZM_EMPTY_FUNCTION } from '@prizm-ui/core';
import * as i0 from "@angular/core";
export class PrizmInputNgControl extends PrizmInputControl {
    get value() {
        return this.previousInternalValue$$.value ?? this.fallbackValue;
    }
    get safeCurrentValue() {
        return this.rawValue ?? this.fallbackValue;
    }
    get empty() {
        return this.isEmpty(this.value);
    }
    get value$() {
        return this.previousInternalValue$$.asObservable().pipe(map(i => i ?? this.fallbackValue));
    }
    isEmpty(value) {
        return !value && !this.focusableElement?.nativeElement?.value;
    }
    get required() {
        // for work Validators.required
        if (this.ngControl.control?.hasValidator(Validators.required))
            return true;
        // for work [required] attributes
        const validator = this.ngControl?.validator;
        if (!validator) {
            return false;
        }
        const validation = validator({});
        // eslint-disable-next-line no-prototype-builtins
        return Boolean(validation && validation.hasOwnProperty('required'));
    }
    get disabled() {
        return !!this.ngControl?.disabled;
    }
    /** Whether the control is validity. */
    get invalid() {
        return !!this.ngControl?.invalid;
    }
    /** Whether the control is validity. */
    get touched() {
        return !!this.ngControl?.touched;
    }
    constructor(injector, valueTransformer) {
        super();
        this.injector = injector;
        this.valueTransformer = valueTransformer;
        this.elRef_ = inject((ElementRef));
        this.previousInternalValue$$ = new BehaviorSubject(null);
        this.onChange = PRIZM_EMPTY_FUNCTION;
        this.onTouch = PRIZM_EMPTY_FUNCTION;
        this.onTouched = PRIZM_EMPTY_FUNCTION;
        this.fallbackValue = null;
        this.destroy$ = this.injector.get(PrizmDestroyService);
        this.changeDetectorRef = this.injector.get(ChangeDetectorRef);
        this.layoutComponent = this.injector.get(PrizmInputLayoutComponent, null);
    }
    ngOnInit() {
        this.ngControl = this.injector.get(NgControl);
        this.initFocusListeners();
        console.assert(!!this.ngControl, `NgControl not injected in ${this.constructor.name}!\n`, 'Use [(ngModel)] or [formControl] or formControlName for correct work.');
        this.ngControl?.statusChanges
            ?.pipe(tap(i => this.stateChanges.next()), takeUntil(this.destroy$))
            .subscribe();
    }
    initFocusListeners() {
        merge(fromEvent(this.elRef_.nativeElement, 'focusout'), fromEvent(this.elRef_.nativeElement, 'focusin'))
            .pipe(tap(() => this.stateChanges.next()), takeUntil(this.destroy$))
            .subscribe();
    }
    valueIdenticalComparator(oldValue, newValue) {
        return oldValue === newValue;
    }
    updateValue(value) {
        if (this.disabled || this.valueIdenticalComparator(this.value, value)) {
            return;
        }
        this.previousInternalValue$$.next(value);
        this.controlSetValue(value);
    }
    clear(ev) {
        this.updateValue(null);
        this.markAsDirty();
    }
    setDisabledState(isDisabled) {
        this.checkControlUpdate();
        this.stateChanges.next();
    }
    registerOnChange(onChange) {
        this.onChange = (componentValue) => {
            onChange(this.toControlValue(componentValue));
        };
    }
    registerOnTouched(fn) {
        this.onTouch = () => {
            fn();
        };
    }
    writeValue(value) {
        const controlValue = this.ngControl instanceof NgModel && this.previousInternalValue$$.value === undefined
            ? this.ngControl.model
            : value;
        this.refreshLocalValue(this.fromControlValue(controlValue));
        // sync on change
        this.stateChanges.next();
    }
    refreshLocalValue(value) {
        this.previousInternalValue$$.next(value);
        this.checkControlUpdate();
    }
    updateFocused(focused) {
        if (!focused) {
            this.controlMarkAsTouched();
        }
    }
    controlMarkAsTouched() {
        this.onTouched();
        this.checkControlUpdate();
    }
    controlSetValue(value) {
        this.onChange(value);
        this.checkControlUpdate();
    }
    checkControlUpdate() {
        this.changeDetectorRef.markForCheck();
    }
    get rawValue() {
        const { ngControl } = this;
        if (ngControl === null) {
            return undefined;
        }
        const controlValue = ngControl instanceof NgModel /*&& this.previousInternalValue === undefined*/
            ? ngControl.viewModel
            : ngControl.value;
        return this.fromControlValue(controlValue);
    }
    fromControlValue(controlValue) {
        return this.valueTransformer
            ? this.valueTransformer?.fromControlValue(controlValue)
            : controlValue;
    }
    toControlValue(componentValue) {
        return this.valueTransformer ? this.valueTransformer?.toControlValue(componentValue) : componentValue;
    }
    markAsTouched() {
        this.ngControl.control?.markAsTouched();
    }
    markAsDirty() {
        this.ngControl.control?.markAsDirty();
    }
}
PrizmInputNgControl.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PrizmInputNgControl, deps: "invalid", target: i0.ɵɵFactoryTarget.Directive });
PrizmInputNgControl.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "15.2.9", type: PrizmInputNgControl, usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PrizmInputNgControl, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i0.Injector }, { type: undefined }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQtbmctY29udHJvbC5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvaW5wdXQvY29tbW9uL2Jhc2UvaW5wdXQtbmctY29udHJvbC5jbGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ25HLE9BQU8sRUFBeUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFFckUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBR3RELE1BQU0sT0FBZ0IsbUJBQ3BCLFNBQVEsaUJBQW9CO0lBYzVCLElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssSUFBSyxJQUFJLENBQUMsYUFBbUIsQ0FBQztJQUN6RSxDQUFDO0lBSUQsSUFBSSxnQkFBZ0I7UUFDbEIsT0FBTyxJQUFJLENBQUMsUUFBUSxJQUFLLElBQUksQ0FBQyxhQUFtQixDQUFDO0lBQ3BELENBQUM7SUFFRCxJQUFJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxP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QUFtQjsyRkFBbkIsbUJBQW1CO2tCQUR4QyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgaW5qZWN0LCBJbmplY3RvciwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOZ0NvbnRyb2wsIE5nTW9kZWwsIFZhbGlkYXRvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBQcml6bUlucHV0Q29udHJvbCB9IGZyb20gJy4vaW5wdXQtY29udHJvbC5jbGFzcyc7XG5pbXBvcnQgeyBQcml6bURlc3Ryb3lTZXJ2aWNlIH0gZnJvbSAnQHByaXptLXVpL2hlbHBlcnMnO1xuaW1wb3J0IHsgbWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFByaXptSW5wdXRMYXlvdXRDb21wb25lbnQgfSBmcm9tICcuLi9pbnB1dC1sYXlvdXQnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmcm9tRXZlbnQsIG1lcmdlLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBQcml6bUNvbnRyb2xWYWx1ZVRyYW5zZm9ybWVyIH0gZnJvbSAnLi4vLi4vLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgUFJJWk1fRU1QVFlfRlVOQ1RJT04gfSBmcm9tICdAcHJpem0tdWkvY29yZSc7XG5cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFByaXptSW5wdXROZ0NvbnRyb2w8VD5cbiAgZXh0ZW5kcyBQcml6bUlucHV0Q29udHJvbDxUPlxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQ29udHJvbFZhbHVlQWNjZXNzb3JcbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGVsUmVmXyA9IGluamVjdChFbGVtZW50UmVmPEhUTUxJbnB1dEVsZW1lbnQ+KTtcbiAgcmVhZG9ubHkgZGVzdHJveSQhOiBQcml6bURlc3Ryb3lTZXJ2aWNlO1xuICBuZ0NvbnRyb2whOiBOZ0NvbnRyb2w7XG4gIHJlYWRvbmx5IGNoYW5nZURldGVjdG9yUmVmITogQ2hhbmdlRGV0ZWN0b3JSZWY7XG4gIHJlYWRvbmx5IGxheW91dENvbXBvbmVudD86IFByaXptSW5wdXRMYXlvdXRDb21wb25lbnQgfCBudWxsO1xuICBwcml2YXRlIHByZXZpb3VzSW50ZXJuYWxWYWx1ZSQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUIHwgbnVsbD4obnVsbCk7XG4gIG9uQ2hhbmdlOiAodmFsOiBUKSA9PiB2b2lkID0gUFJJWk1fRU1QVFlfRlVOQ1RJT047XG4gIG9uVG91Y2g6ICh2YWw6IFQpID0+IHZvaWQgPSBQUklaTV9FTVBUWV9GVU5DVElPTjtcbiAgb25Ub3VjaGVkID0gUFJJWk1fRU1QVFlfRlVOQ1RJT047XG4gIHByb3RlY3RlZCByZWFkb25seSBmb2N1c2FibGVFbGVtZW50PzogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PiB8IGFueTtcblxuICBnZXQgdmFsdWUoKTogVCB7XG4gICAgcmV0dXJuIHRoaXMucHJldmlvdXNJbnRlcm5hbFZhbHVlJCQudmFsdWUgPz8gKHRoaXMuZmFsbGJhY2tWYWx1ZSBhcyBUKTtcbiAgfVxuXG4gIHB1YmxpYyBmYWxsYmFja1ZhbHVlOiBUIHwgbnVsbCA9IG51bGw7XG5cbiAgZ2V0IHNhZmVDdXJyZW50VmFsdWUoKTogVCB7XG4gICAgcmV0dXJuIHRoaXMucmF3VmFsdWUgPz8gKHRoaXMuZmFsbGJhY2tWYWx1ZSBhcyBUKTtcbiAgfVxuXG4gIGdldCBlbXB0eSgpOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuaXNFbXB0eSh0aGlzLnZhbHVlKTtcbiAgfVxuXG4gIGdldCB2YWx1ZSQoKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMucHJldmlvdXNJbnRlcm5hbFZhbHVlJCQuYXNPYnNlcnZhYmxlKCkucGlwZShtYXAoaSA9PiBpID8/IHRoaXMuZmFsbGJhY2tWYWx1ZSkpIGFzIGFueTtcbiAgfVxuXG4gIHB1YmxpYyBpc0VtcHR5KHZhbHVlOiBUKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICF2YWx1ZSAmJiAhdGhpcy5mb2N1c2FibGVFbGVtZW50Py5uYXRpdmVFbGVtZW50Py52YWx1ZTtcbiAgfVxuXG4gIGdldCByZXF1aXJlZCgpIHtcbiAgICAvLyBmb3Igd29yayBWYWxpZGF0b3JzLnJlcXVpcmVkXG4gICAgaWYgKHRoaXMubmdDb250cm9sLmNvbnRyb2w/Lmhhc1ZhbGlkYXRvcihWYWxpZGF0b3JzLnJlcXVpcmVkKSkgcmV0dXJuIHRydWU7XG5cbiAgICAvLyBmb3Igd29yayBbcmVxdWlyZWRdIGF0dHJpYnV0ZXNcbiAgICBjb25zdCB2YWxpZGF0b3IgPSB0aGlzLm5nQ29udHJvbD8udmFsaWRhdG9yO1xuICAgIGlmICghdmFsaWRhdG9yKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHZhbGlkYXRvcih7fSBhcyBBYnN0cmFjdENvbnRyb2wpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICByZXR1cm4gQm9vbGVhbih2YWxpZGF0aW9uICYmIHZhbGlkYXRpb24uaGFzT3duUHJvcGVydHkoJ3JlcXVpcmVkJykpO1xuICB9XG5cbiAgZ2V0IGRpc2FibGVkKCkge1xuICAgIHJldHVybiAhIXRoaXMubmdDb250cm9sPy5kaXNhYmxlZDtcbiAgfVxuXG4gIC8qKiBXaGV0aGVyIHRoZSBjb250cm9sIGlzIHZhbGlkaXR5LiAqL1xuICBnZXQgaW52YWxpZCgpIHtcbiAgICByZXR1cm4gISF0aGlzLm5nQ29udHJvbD8uaW52YWxpZDtcbiAgfVxuXG4gIC8qKiBXaGV0aGVyIHRoZSBjb250cm9sIGlzIHZhbGlkaXR5LiAqL1xuICBnZXQgdG91Y2hlZCgpIHtcbiAgICByZXR1cm4gISF0aGlzLm5nQ29udHJvbD8udG91Y2hlZDtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHJlYWRvbmx5IHZhbHVlVHJhbnNmb3JtZXI/OiBQcml6bUNvbnRyb2xWYWx1ZVRyYW5zZm9ybWVyPFQ+IHwgbnVsbFxuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5kZXN0cm95JCA9IHRoaXMuaW5qZWN0b3IuZ2V0KFByaXptRGVzdHJveVNlcnZpY2UpO1xuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYgPSB0aGlzLmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZik7XG4gICAgdGhpcy5sYXlvdXRDb21wb25lbnQgPSB0aGlzLmluamVjdG9yLmdldChQcml6bUlucHV0TGF5b3V0Q29tcG9uZW50LCBudWxsKTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMubmdDb250cm9sID0gdGhpcy5pbmplY3Rvci5nZXQoTmdDb250cm9sKTtcblxuICAgIHRoaXMuaW5pdEZvY3VzTGlzdGVuZXJzKCk7XG5cbiAgICBjb25zb2xlLmFzc2VydChcbiAgICAgICEhdGhpcy5uZ0NvbnRyb2wsXG4gICAgICBgTmdDb250cm9sIG5vdCBpbmplY3RlZCBpbiAke3RoaXMuY29uc3RydWN0b3IubmFtZX0hXFxuYCxcbiAgICAgICdVc2UgWyhuZ01vZGVsKV0gb3IgW2Zvcm1Db250cm9sXSBvciBmb3JtQ29udHJvbE5hbWUgZm9yIGNvcnJlY3Qgd29yay4nXG4gICAgKTtcblxuICAgIHRoaXMubmdDb250cm9sPy5zdGF0dXNDaGFuZ2VzXG4gICAgICA/LnBpcGUoXG4gICAgICAgIHRhcChpID0+IHRoaXMuc3RhdGVDaGFuZ2VzLm5leHQoKSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRGb2N1c0xpc3RlbmVycygpOiB2b2lkIHtcbiAgICBtZXJnZShmcm9tRXZlbnQodGhpcy5lbFJlZl8ubmF0aXZlRWxlbWVudCwgJ2ZvY3Vzb3V0JyksIGZyb21FdmVudCh0aGlzLmVsUmVmXy5uYXRpdmVFbGVtZW50LCAnZm9jdXNpbicpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLnN0YXRlQ2hhbmdlcy5uZXh0KCkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB2YWx1ZUlkZW50aWNhbENvbXBhcmF0b3Iob2xkVmFsdWU6IFQsIG5ld1ZhbHVlOiBUKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9sZFZhbHVlID09PSBuZXdWYWx1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCB1cGRhdGVWYWx1ZSh2YWx1ZTogVCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRpc2FibGVkIHx8IHRoaXMudmFsdWVJZGVudGljYWxDb21wYXJhdG9yKHRoaXMudmFsdWUsIHZhbHVlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucHJldmlvdXNJbnRlcm5hbFZhbHVlJCQubmV4dCh2YWx1ZSk7XG4gICAgdGhpcy5jb250cm9sU2V0VmFsdWUodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGNsZWFyKGV2OiBNb3VzZUV2ZW50KSB7XG4gICAgdGhpcy51cGRhdGVWYWx1ZShudWxsIGFzIGFueSk7XG4gICAgdGhpcy5tYXJrQXNEaXJ0eSgpO1xuICB9XG5cbiAgcHVibGljIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbikge1xuICAgIHRoaXMuY2hlY2tDb250cm9sVXBkYXRlKCk7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyT25DaGFuZ2Uob25DaGFuZ2U6IGFueSk6IHZvaWQge1xuICAgIHRoaXMub25DaGFuZ2UgPSAoY29tcG9uZW50VmFsdWU6IFQpOiB2b2lkID0+IHtcbiAgICAgIG9uQ2hhbmdlKHRoaXMudG9Db250cm9sVmFsdWUoY29tcG9uZW50VmFsdWUpKTtcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpIHtcbiAgICB0aGlzLm9uVG91Y2ggPSAoKSA9PiB7XG4gICAgICBmbigpO1xuICAgIH07XG4gIH1cblxuICBwdWJsaWMgd3JpdGVWYWx1ZSh2YWx1ZTogVCk6IHZvaWQge1xuICAgIGNvbnN0IGNvbnRyb2xWYWx1ZSA9XG4gICAgICB0aGlzLm5nQ29udHJvbCBpbnN0YW5jZW9mIE5nTW9kZWwgJiYgdGhpcy5wcmV2aW91c0ludGVybmFsVmFsdWUkJC52YWx1ZSA9PT0gdW5kZWZpbmVkXG4gICAgICAgID8gdGhpcy5uZ0NvbnRyb2wubW9kZWxcbiAgICAgICAgOiB2YWx1ZTtcblxuICAgIHRoaXMucmVmcmVzaExvY2FsVmFsdWUodGhpcy5mcm9tQ29udHJvbFZhbHVlKGNvbnRyb2xWYWx1ZSkpO1xuICAgIC8vIHN5bmMgb24gY2hhbmdlXG4gICAgdGhpcy5zdGF0ZUNoYW5nZXMubmV4dCgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWZyZXNoTG9jYWxWYWx1ZSh2YWx1ZTogVCB8IG51bGwpOiB2b2lkIHtcbiAgICB0aGlzLnByZXZpb3VzSW50ZXJuYWxWYWx1ZSQkLm5leHQodmFsdWUpO1xuICAgIHRoaXMuY2hlY2tDb250cm9sVXBkYXRlKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlRm9jdXNlZChmb2N1c2VkOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKCFmb2N1c2VkKSB7XG4gICAgICB0aGlzLmNvbnRyb2xNYXJrQXNUb3VjaGVkKCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGNvbnRyb2xNYXJrQXNUb3VjaGVkKCk6IHZvaWQge1xuICAgIHRoaXMub25Ub3VjaGVkKCk7XG4gICAgdGhpcy5jaGVja0NvbnRyb2xVcGRhdGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgY29udHJvbFNldFZhbHVlKHZhbHVlOiBUKTogdm9pZCB7XG4gICAgdGhpcy5vbkNoYW5nZSh2YWx1ZSk7XG4gICAgdGhpcy5jaGVja0NvbnRyb2xVcGRhdGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBjaGVja0NvbnRyb2xVcGRhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IHJhd1ZhbHVlKCk6IFQgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgbmdDb250cm9sIH0gPSB0aGlzO1xuXG4gICAgaWYgKG5nQ29udHJvbCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBjb25zdCBjb250cm9sVmFsdWUgPVxuICAgICAgbmdDb250cm9sIGluc3RhbmNlb2YgTmdNb2RlbCAvKiYmIHRoaXMucHJldmlvdXNJbnRlcm5hbFZhbHVlID09PSB1bmRlZmluZWQqL1xuICAgICAgICA/IG5nQ29udHJvbC52aWV3TW9kZWxcbiAgICAgICAgOiBuZ0NvbnRyb2wudmFsdWU7XG5cbiAgICByZXR1cm4gdGhpcy5mcm9tQ29udHJvbFZhbHVlKGNvbnRyb2xWYWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIGZyb21Db250cm9sVmFsdWUoY29udHJvbFZhbHVlOiB1bmtub3duKTogVCB7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVUcmFuc2Zvcm1lclxuICAgICAgPyB0aGlzLnZhbHVlVHJhbnNmb3JtZXI/LmZyb21Db250cm9sVmFsdWUoY29udHJvbFZhbHVlKVxuICAgICAgOiAoY29udHJvbFZhbHVlIGFzIFQpO1xuICB9XG5cbiAgcHJpdmF0ZSB0b0NvbnRyb2xWYWx1ZShjb21wb25lbnRWYWx1ZTogVCk6IHVua25vd24ge1xuICAgIHJldHVybiB0aGlzLnZhbHVlVHJhbnNmb3JtZXIgPyB0aGlzLnZhbHVlVHJhbnNmb3JtZXI/LnRvQ29udHJvbFZhbHVlKGNvbXBvbmVudFZhbHVlKSA6IGNvbXBvbmVudFZhbHVlO1xuICB9XG5cbiAgcHVibGljIG1hcmtBc1RvdWNoZWQoKTogdm9pZCB7XG4gICAgdGhpcy5uZ0NvbnRyb2wuY29udHJvbD8ubWFya0FzVG91Y2hlZCgpO1xuICB9XG5cbiAgcHVibGljIG1hcmtBc0RpcnR5KCk6IHZvaWQge1xuICAgIHRoaXMubmdDb250cm9sLmNvbnRyb2w/Lm1hcmtBc0RpcnR5KCk7XG4gIH1cbn1cbiJdfQ==