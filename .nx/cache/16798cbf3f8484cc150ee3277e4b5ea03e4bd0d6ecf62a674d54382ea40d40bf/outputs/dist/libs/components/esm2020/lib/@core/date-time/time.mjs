import { prizmInRange } from '../../util/math/in-range';
import { PRIZM_HOURS_IN_DAY, PRIZM_MILLISECONDS_IN_DAY, PRIZM_MILLISECONDS_IN_HOUR, PRIZM_MILLISECONDS_IN_MINUTE, PRIZM_MINUTES_IN_HOUR, PRIZM_SECONDS_IN_MINUTE, } from './date-time';
import { prizmAssert, prizmPadStart } from '@prizm-ui/core';
/**
 * Immutable time object with hours, minutes, seconds and ms
 */
export class PrizmTime {
    static correctTime(parsedTime) {
        let { hours, minutes, seconds } = parsedTime;
        if (hours > 23)
            hours = 23;
        if (minutes > 59)
            minutes = 59;
        if (seconds > 59)
            seconds = 59;
        return new PrizmTime(hours, minutes, seconds, parsedTime.ms);
    }
    constructor(hours, minutes, seconds = 0, ms = 0) {
        this.hours = hours;
        this.minutes = minutes;
        this.seconds = seconds;
        this.ms = ms;
        prizmAssert.assert(PrizmTime.isValidTime(hours, minutes, seconds, ms), `Time must be real, but got:`, hours, minutes, seconds, ms);
    }
    /**
     * Checks if time is valid
     */
    static isValidTime(hours, minutes, seconds = 0, ms = 0) {
        return (Number.isInteger(hours) &&
            prizmInRange(hours, 0, PRIZM_HOURS_IN_DAY) &&
            Number.isInteger(minutes) &&
            prizmInRange(minutes, 0, PRIZM_MINUTES_IN_HOUR) &&
            Number.isInteger(seconds) &&
            prizmInRange(seconds, 0, PRIZM_SECONDS_IN_MINUTE) &&
            Number.isInteger(ms) &&
            prizmInRange(ms, 0, 1000));
    }
    /**
     * Current UTC time.
     */
    static current() {
        return PrizmTime.fromAbsoluteMilliseconds(Date.now() % PRIZM_MILLISECONDS_IN_DAY);
    }
    /**
     * Current time in local timezone
     */
    static currentLocal() {
        const date = new Date();
        return PrizmTime.fromAbsoluteMilliseconds((Date.now() - date.getTimezoneOffset() * PRIZM_MILLISECONDS_IN_MINUTE) % PRIZM_MILLISECONDS_IN_DAY);
    }
    /**
     * Calculates PrizmTime from milliseconds
     */
    static fromAbsoluteMilliseconds(milliseconds) {
        prizmAssert.assert(Number.isInteger(milliseconds));
        prizmAssert.assert(prizmInRange(milliseconds, 0, PRIZM_MILLISECONDS_IN_DAY), `Milliseconds must be below ${PRIZM_MILLISECONDS_IN_DAY} (milliseconds in a day).`);
        const hours = Math.floor(milliseconds / PRIZM_MILLISECONDS_IN_HOUR);
        const minutes = Math.floor((milliseconds % PRIZM_MILLISECONDS_IN_HOUR) / PRIZM_MILLISECONDS_IN_MINUTE);
        const seconds = Math.floor(((milliseconds % PRIZM_MILLISECONDS_IN_HOUR) % PRIZM_MILLISECONDS_IN_MINUTE) / 1000) || 0;
        const ms = Math.floor(((milliseconds % PRIZM_MILLISECONDS_IN_HOUR) % PRIZM_MILLISECONDS_IN_MINUTE) % 1000) || 0;
        return new PrizmTime(hours, minutes, seconds, ms);
    }
    /**
     * Parses string into PrizmTime object
     */
    static fromString(time) {
        const hours = Number(time.slice(0, 2));
        const minutes = Number(time.slice(3, 5));
        const seconds = Number(time.slice(6, 8)) || 0;
        const ms = Number(time.slice(9, 12)) || 0;
        return new PrizmTime(hours, minutes, seconds, ms);
    }
    /**
     * Converts Date object into PrizmTime
     * @param date
     */
    static fromLocalNativeDate(date) {
        return new PrizmTime(date.getHours(), date.getMinutes(), date.getSeconds(), date.getMilliseconds());
    }
    /**
     * Shifts time by hours and minutes
     */
    shift({ hours = 0, minutes = 0, seconds = 0, ms = 0 }) {
        const newMs = (1000 + this.ms + (ms % 1000)) % 1000;
        const secondsInMs = ms < 0 ? Math.ceil(ms / 1000) : Math.floor(ms / 1000);
        const secondsToAdd = secondsInMs + seconds;
        const newSeconds = (60 + this.seconds + (secondsToAdd % 60)) % 60;
        const minutesInSeconds = secondsToAdd < 0 ? Math.ceil(secondsToAdd / 60) : Math.floor(secondsToAdd / 60);
        const minutesToAdd = minutesInSeconds + minutes;
        const newMinutes = (60 + this.minutes + (minutesToAdd % 60)) % 60;
        const hoursInMinutes = minutesToAdd < 0 ? Math.ceil(minutesToAdd / 60) : Math.floor(minutesToAdd / 60);
        const hoursToAdd = hoursInMinutes + hours;
        const newHours = (24 + this.hours + (hoursToAdd % 24)) % 24;
        return new PrizmTime(newHours, newMinutes, newSeconds, newMs);
    }
    timeLimit(minTime, maxTime) {
        let result = new PrizmTime(this.hours, this.minutes, this.seconds, this.ms);
        if (minTime && minTime?.toAbsoluteMilliseconds() > result.toAbsoluteMilliseconds())
            result = minTime;
        if (maxTime && maxTime?.toAbsoluteMilliseconds() < result.toAbsoluteMilliseconds())
            result = maxTime;
        return result;
    }
    /**
     * Converts PrizmTime to string
     */
    toString(mode) {
        const needAddMs = mode === `HH:MM:SS.MSS` || (!mode && this.ms > 0);
        const needAddSeconds = needAddMs || mode === `HH:MM:SS` || (!mode && this.seconds > 0);
        return (`${this.formatTime(this.hours)}:${this.formatTime(this.minutes)}` +
            `${needAddSeconds ? `:${this.formatTime(this.seconds)}` : ``}` +
            `${needAddMs ? `.${this.formatTime(this.ms, 3)}` : ``}`);
    }
    valueOf() {
        return this.toAbsoluteMilliseconds();
    }
    /**
     * Returns the primitive value of the given Date object.
     * Depending on the argument, the method can return either a string or a number.
     * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/@@toPrimitive
     */
    [Symbol.toPrimitive](hint) {
        return Date.prototype[Symbol.toPrimitive].call(this, hint);
    }
    /**
     * Converts PrizmTime to milliseconds
     */
    toAbsoluteMilliseconds() {
        return (this.hours * PRIZM_MILLISECONDS_IN_HOUR +
            this.minutes * PRIZM_MILLISECONDS_IN_MINUTE +
            this.seconds * 1000 +
            this.ms);
    }
    formatTime(time, digits = 2) {
        return prizmPadStart(String(time), digits, `0`);
    }
    isSameTime(time) {
        return (this.ms === time.ms &&
            this.seconds === time.seconds &&
            this.hours === time.hours &&
            this.minutes === time.minutes);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9zcmMvbGliL0Bjb3JlL2RhdGUtdGltZS90aW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN4RCxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLHlCQUF5QixFQUN6QiwwQkFBMEIsRUFDMUIsNEJBQTRCLEVBQzVCLHFCQUFxQixFQUNyQix1QkFBdUIsR0FDeEIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU1RDs7R0FFRztBQUNILE1BQU0sT0FBTyxTQUFTO0lBQ2IsTUFBTSxDQUFDLFdBQVcsQ0FBQyxVQUFxQjtRQUM3QyxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxVQUFVLENBQUM7UUFDN0MsSUFBSSxLQUFLLEdBQUcsRUFBRTtZQUFFLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDM0IsSUFBSSxPQUFPLEdBQUcsRUFBRTtZQUFFLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDL0IsSUFBSSxPQUFPLEdBQUcsRUFBRTtZQUFFLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDL0IsT0FBTyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVELFlBQ1csS0FBYSxFQUNiLE9BQWUsRUFDZixVQUFrQixDQUFDLEVBQ25CLEtBQWEsQ0FBQztRQUhkLFVBQUssR0FBTCxLQUFLLENBQVE7UUFDYixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBRXZCLFdBQVcsQ0FBQyxN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QUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUxQyxPQUFPLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFRDs7O09BR0c7SUFDSSxNQUFNLENBQUMsbUJBQW1CLENBQUMsSUFBVTtRQUMxQyxPQUFPLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO0lBQ3RHLENBQUM7SUFFRDs7T0FFRztJQUNJLEtBQUssQ0FBQyxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsT0FBTyxHQUFHLENBQUMsRUFBRSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQWlCO1FBQ3pFLE1BQU0sS0FBSyxHQUFHLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFcEQsTUFBTSxXQUFXLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQzFFLE1BQU0sWUFBWSxHQUFHLFdBQVcsR0FBRyxPQUFPLENBQUM7UUFDM0MsTUFBTSxVQUFVLEdBQUcs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LENBQUMsV0FBVyxDQUFDLENBQUMsSUFBWTtRQUN0QyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVEOztPQUVHO0lBQ0ksc0JBQXNCO1FBQzNCLE9BQU8sQ0FDTCxJQUFJLENBQUMsS0FBSyxHQUFHLDBCQUEwQjtZQUN2QyxJQUFJLENBQUMsT0FBTyxHQUFHLDRCQUE0QjtZQUMzQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUk7WUFDbkIsSUFBSSxDQUFDLEVBQUUsQ0FDUixDQUFDO0lBQ0osQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFZLEVBQUUsTUFBTSxHQUFHLENBQUM7UUFDekMsT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU0sVUFBVSxDQUFDLElBQWU7UUFDL0IsT0FBTyxDQUNMLElBQUksQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUU7WUFDbkIsSUFBSSxDQUFDLE9BQU8sS0FBSyxJQUFJLENBQUMsT0FBTztZQUM3QixJQUFJLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxLQUFLO1lBQ3pCLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FDOUIsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByaXptVGltZUxpa2UgfSBmcm9tICcuLi8uLi90eXBlcy90aW1lLWxpa2UnO1xuaW1wb3J0IHsgUHJpem1UaW1lTW9kZSB9IGZyb20gJy4uLy4uL3R5cGVzL3RpbWUtbW9kZSc7XG5pbXBvcnQgeyBwcml6bUluUmFuZ2UgfSBmcm9tICcuLi8uLi91dGlsL21hdGgvaW4tcmFuZ2UnO1xuaW1wb3J0IHtcbiAgUFJJWk1fSE9VUlNfSU5fREFZLFxuICBQUklaTV9NSUxMSVNFQ09ORFNfSU5fREFZLFxuICBQUklaTV9NSUxMSVNFQ09ORFNfSU5fSE9VUixcbiAgUFJJWk1fTUlMTElTRUNPTkRTX0lOX01JTlVURSxcbiAgUFJJWk1fTUlOVVRFU19JTl9IT1VSLFxuICBQUklaTV9TRUNPTkRTX0lOX01JTlVURSxcbn0gZnJvbSAnLi9kYXRlLXRpbWUnO1xuaW1wb3J0IHsgcHJpem1Bc3NlcnQsIHByaXptUGFkU3RhcnQgfSBmcm9tICdAcHJpem0tdWkvY29yZSc7XG5cbi8qKlxuICogSW1tdXRhYmxlIHRpbWUgb2JqZWN0IHdpdGggaG91cnMsIG1pbnV0ZXMsIHNlY29uZHMgYW5kIG1zXG4gKi9cbmV4cG9ydCBjbGFzcyBQcml6bVRpbWUgaW1wbGVtZW50cyBQcml6bVRpbWVMaWtlIHtcbiAgcHVibGljIHN0YXRpYyBjb3JyZWN0VGltZShwYXJzZWRUaW1lOiBQcml6bVRpbWUpOiBQcml6bVRpbWUge1xuICAgIGxldCB7IGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzIH0gPSBwYXJzZWRUaW1lO1xuICAgIGlmIChob3VycyA+IDIzKSBob3VycyA9IDIzO1xuICAgIGlmIChtaW51dGVzID4gNTkpIG1pbnV0ZXMgPSA1OTtcbiAgICBpZiAoc2Vjb25kcyA+IDU5KSBzZWNvbmRzID0gNTk7XG4gICAgcmV0dXJuIG5ldyBQcml6bVRpbWUoaG91cnMsIG1pbnV0ZXMsIHNlY29uZHMsIHBhcnNlZFRpbWUubXMpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgaG91cnM6IG51bWJlcixcbiAgICByZWFkb25seSBtaW51dGVzOiBudW1iZXIsXG4gICAgcmVhZG9ubHkgc2Vjb25kczogbnVtYmVyID0gMCxcbiAgICByZWFkb25seSBtczogbnVtYmVyID0gMFxuICApIHtcbiAgICBwcml6bUFzc2VydC5hc3NlcnQoXG4gICAgICBQcml6bVRpbWUuaXNWYWxpZFRpbWUoaG91cnMsIG1pbnV0ZXMsIHNlY29uZHMsIG1zKSxcbiAgICAgIGBUaW1lIG11c3QgYmUgcmVhbCwgYnV0IGdvdDpgLFxuICAgICAgaG91cnMsXG4gICAgICBtaW51dGVzLFxuICAgICAgc2Vjb25kcyxcbiAgICAgIG1zXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgdGltZSBpcyB2YWxpZFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBpc1ZhbGlkVGltZShob3VyczogbnVtYmVyLCBtaW51dGVzOiBudW1iZXIsIHNlY29uZHMgPSAwLCBtcyA9IDApOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgTnVtYmVyLmlzSW50ZWdlcihob3VycykgJiZcbiAgICAgIHByaXptSW5SYW5nZShob3VycywgMCwgUFJJWk1fSE9VUlNfSU5fREFZKSAmJlxuICAgICAgTnVtYmVyLmlzSW50ZWdlcihtaW51dGVzKSAmJlxuICAgICAgcHJpem1JblJhbmdlKG1pbnV0ZXMsIDAsIFBSSVpNX01JTlVURVNfSU5fSE9VUikgJiZcbiAgICAgIE51bWJlci5pc0ludGVnZXIoc2Vjb25kcykgJiZcbiAgICAgIHByaXptSW5SYW5nZShzZWNvbmRzLCAwLCBQUklaTV9TRUNPTkRTX0lOX01JTlVURSkgJiZcbiAgICAgIE51bWJlci5pc0ludGVnZXIobXMpICYmXG4gICAgICBwcml6bUluUmFuZ2UobXMsIDAsIDEwMDApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDdXJyZW50IFVUQyB0aW1lLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjdXJyZW50KCk6IFByaXptVGltZSB7XG4gICAgcmV0dXJuIFByaXptVGltZS5mcm9tQWJzb2x1dGVNaWxsaXNlY29uZHMoRGF0ZS5ub3coKSAlIFBSSVpNX01JTExJU0VDT05EU19JTl9EQVkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEN1cnJlbnQgdGltZSBpbiBsb2NhbCB0aW1lem9uZVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjdXJyZW50TG9jYWwoKTogUHJpem1UaW1lIHtcbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoKTtcblxuICAgIHJldHVybiBQcml6bVRpbWUuZnJvbUFic29sdXRlTWlsbGlzZWNvbmRzKFxuICAgICAgKERhdGUubm93KCkgLSBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkgKiBQUklaTV9NSUxMSVNFQ09ORFNfSU5fTUlOVVRFKSAlIFBSSVpNX01JTExJU0VDT05EU19JTl9EQVlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgUHJpem1UaW1lIGZyb20gbWlsbGlzZWNvbmRzXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21BYnNvbHV0ZU1pbGxpc2Vjb25kcyhtaWxsaXNlY29uZHM6IG51bWJlcik6IFByaXptVGltZSB7XG4gICAgcHJpem1Bc3NlcnQuYXNzZXJ0KE51bWJlci5pc0ludGVnZXIobWlsbGlzZWNvbmRzKSk7XG4gICAgcHJpem1Bc3NlcnQuYXNzZXJ0KFxuICAgICAgcHJpem1JblJhbmdlKG1pbGxpc2Vjb25kcywgMCwgUFJJWk1fTUlMTElTRUNPTkRTX0lOX0RBWSksXG4gICAgICBgTWlsbGlzZWNvbmRzIG11c3QgYmUgYmVsb3cgJHtQUklaTV9NSUxMSVNFQ09ORFNfSU5fREFZfSAobWlsbGlzZWNvbmRzIGluIGEgZGF5KS5gXG4gICAgKTtcblxuICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihtaWxsaXNlY29uZHMgLyBQUklaTV9NSUxMSVNFQ09ORFNfSU5fSE9VUik7XG4gICAgY29uc3QgbWludXRlcyA9IE1hdGguZmxvb3IoKG1pbGxpc2Vjb25kcyAlIFBSSVpNX01JTExJU0VDT05EU19JTl9IT1VSKSAvIFBSSVpNX01JTExJU0VDT05EU19JTl9NSU5VVEUpO1xuICAgIGNvbnN0IHNlY29uZHMgPVxuICAgICAgTWF0aC5mbG9vcigoKG1pbGxpc2Vjb25kcyAlIFBSSVpNX01JTExJU0VDT05EU19JTl9IT1VSKSAlIFBSSVpNX01JTExJU0VDT05EU19JTl9NSU5VVEUpIC8gMTAwMCkgfHwgMDtcbiAgICBjb25zdCBtcyA9XG4gICAgICBNYXRoLmZsb29yKCgobWlsbGlzZWNvbmRzICUgUFJJWk1fTUlMTElTRUNPTkRTX0lOX0hPVVIpICUgUFJJWk1fTUlMTElTRUNPTkRTX0lOX01JTlVURSkgJSAxMDAwKSB8fCAwO1xuXG4gICAgcmV0dXJuIG5ldyBQcml6bVRpbWUoaG91cnMsIG1pbnV0ZXMsIHNlY29uZHMsIG1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZXMgc3RyaW5nIGludG8gUHJpem1UaW1lIG9iamVjdFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmcm9tU3RyaW5nKHRpbWU6IHN0cmluZyk6IFByaXptVGltZSB7XG4gICAgY29uc3QgaG91cnMgPSBOdW1iZXIodGltZS5zbGljZSgwLCAyKSk7XG4gICAgY29uc3QgbWludXRlcyA9IE51bWJlcih0aW1lLnNsaWNlKDMsIDUpKTtcbiAgICBjb25zdCBzZWNvbmRzID0gTnVtYmVyKHRpbWUuc2xpY2UoNiwgOCkpIHx8IDA7XG4gICAgY29uc3QgbXMgPSBOdW1iZXIodGltZS5zbGljZSg5LCAxMikpIHx8IDA7XG5cbiAgICByZXR1cm4gbmV3IFByaXptVGltZShob3VycywgbWludXRlcywgc2Vjb25kcywgbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIERhdGUgb2JqZWN0IGludG8gUHJpem1UaW1lXG4gICAqIEBwYXJhbSBkYXRlXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21Mb2NhbE5hdGl2ZURhdGUoZGF0ZTogRGF0ZSk6IFByaXptVGltZSB7XG4gICAgcmV0dXJuIG5ldyBQcml6bVRpbWUoZGF0ZS5nZXRIb3VycygpLCBkYXRlLmdldE1pbnV0ZXMoKSwgZGF0ZS5nZXRTZWNvbmRzKCksIGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNoaWZ0cyB0aW1lIGJ5IGhvdXJzIGFuZCBtaW51dGVzXG4gICAqL1xuICBwdWJsaWMgc2hpZnQoeyBob3VycyA9IDAsIG1pbnV0ZXMgPSAwLCBzZWNvbmRzID0gMCwgbXMgPSAwIH06IFByaXptVGltZUxpa2UpOiBQcml6bVRpbWUge1xuICAgIGNvbnN0IG5ld01zID0gKDEwMDAgKyB0aGlzLm1zICsgKG1zICUgMTAwMCkpICUgMTAwMDtcblxuICAgIGNvbnN0IHNlY29uZHNJbk1zID0gbXMgPCAwID8gTWF0aC5jZWlsKG1zIC8gMTAwMCkgOiBNYXRoLmZsb29yKG1zIC8gMTAwMCk7XG4gICAgY29uc3Qgc2Vjb25kc1RvQWRkID0gc2Vjb25kc0luTXMgKyBzZWNvbmRzO1xuICAgIGNvbnN0IG5ld1NlY29uZHMgPSAoNjAgKyB0aGlzLnNlY29uZHMgKyAoc2Vjb25kc1RvQWRkICUgNjApKSAlIDYwO1xuXG4gICAgY29uc3QgbWludXRlc0luU2Vjb25kcyA9IHNlY29uZHNUb0FkZCA8IDAgPyBNYXRoLmNlaWwoc2Vjb25kc1RvQWRkIC8gNjApIDogTWF0aC5mbG9vcihzZWNvbmRzVG9BZGQgLyA2MCk7XG4gICAgY29uc3QgbWludXRlc1RvQWRkID0gbWludXRlc0luU2Vjb25kcyArIG1pbnV0ZXM7XG4gICAgY29uc3QgbmV3TWludXRlcyA9ICg2MCArIHRoaXMubWludXRlcyArIChtaW51dGVzVG9BZGQgJSA2MCkpICUgNjA7XG5cbiAgICBjb25zdCBob3Vyc0luTWludXRlcyA9IG1pbnV0ZXNUb0FkZCA8IDAgPyBNYXRoLmNlaWwobWludXRlc1RvQWRkIC8gNjApIDogTWF0aC5mbG9vcihtaW51dGVzVG9BZGQgLyA2MCk7XG4gICAgY29uc3QgaG91cnNUb0FkZCA9IGhvdXJzSW5NaW51dGVzICsgaG91cnM7XG4gICAgY29uc3QgbmV3SG91cnMgPSAoMjQgKyB0aGlzLmhvdXJzICsgKGhvdXJzVG9BZGQgJSAyNCkpICUgMjQ7XG5cbiAgICByZXR1cm4gbmV3IFByaXptVGltZShuZXdIb3VycywgbmV3TWludXRlcywgbmV3U2Vjb25kcywgbmV3TXMpO1xuICB9XG5cbiAgcHVibGljIHRpbWVMaW1pdChtaW5UaW1lOiBQcml6bVRpbWUgfCBudWxsLCBtYXhUaW1lOiBQcml6bVRpbWUgfCBudWxsKTogUHJpem1UaW1lIHtcbiAgICBsZXQgcmVzdWx0OiBQcml6bVRpbWUgPSBuZXcgUHJpem1UaW1lKHRoaXMuaG91cnMsIHRoaXMubWludXRlcywgdGhpcy5zZWNvbmRzLCB0aGlzLm1zKTtcblxuICAgIGlmIChtaW5UaW1lICYmIG1pblRpbWU/LnRvQWJzb2x1dGVNaWxsaXNlY29uZHMoKSA+IHJlc3VsdC50b0Fic29sdXRlTWlsbGlzZWNvbmRzKCkpIHJlc3VsdCA9IG1pblRpbWU7XG5cbiAgICBpZiAobWF4VGltZSAmJiBtYXhUaW1lPy50b0Fic29sdXRlTWlsbGlzZWNvbmRzKCkgPCByZXN1bHQudG9BYnNvbHV0ZU1pbGxpc2Vjb25kcygpKSByZXN1bHQgPSBtYXhUaW1lO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyBQcml6bVRpbWUgdG8gc3RyaW5nXG4gICAqL1xuICBwdWJsaWMgdG9TdHJpbmcobW9kZT86IFByaXptVGltZU1vZGUpOiBzdHJpbmcge1xuICAgIGNvbnN0IG5lZWRBZGRNcyA9IG1vZGUgPT09IGBISDpNTTpTUy5NU1NgIHx8ICghbW9kZSAmJiB0aGlzLm1zID4gMCk7XG4gICAgY29uc3QgbmVlZEFkZFNlY29uZHMgPSBuZWVkQWRkTXMgfHwgbW9kZSA9PT0gYEhIOk1NOlNTYCB8fCAoIW1vZGUgJiYgdGhpcy5zZWNvbmRzID4gMCk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgYCR7dGhpcy5mb3JtYXRUaW1lKHRoaXMuaG91cnMpfToke3RoaXMuZm9ybWF0VGltZSh0aGlzLm1pbnV0ZXMpfWAgK1xuICAgICAgYCR7bmVlZEFkZFNlY29uZHMgPyBgOiR7dGhpcy5mb3JtYXRUaW1lKHRoaXMuc2Vjb25kcyl9YCA6IGBgfWAgK1xuICAgICAgYCR7bmVlZEFkZE1zID8gYC4ke3RoaXMuZm9ybWF0VGltZSh0aGlzLm1zLCAzKX1gIDogYGB9YFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgdmFsdWVPZigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnRvQWJzb2x1dGVNaWxsaXNlY29uZHMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBwcmltaXRpdmUgdmFsdWUgb2YgdGhlIGdpdmVuIERhdGUgb2JqZWN0LlxuICAgKiBEZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50LCB0aGUgbWV0aG9kIGNhbiByZXR1cm4gZWl0aGVyIGEgc3RyaW5nIG9yIGEgbnVtYmVyLlxuICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0RhdGUvQEB0b1ByaW1pdGl2ZVxuICAgKi9cbiAgcHVibGljIFtTeW1ib2wudG9QcmltaXRpdmVdKGhpbnQ6IHN0cmluZyk6IHN0cmluZyB8IG51bWJlciB7XG4gICAgcmV0dXJuIERhdGUucHJvdG90eXBlW1N5bWJvbC50b1ByaW1pdGl2ZV0uY2FsbCh0aGlzLCBoaW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyBQcml6bVRpbWUgdG8gbWlsbGlzZWNvbmRzXG4gICAqL1xuICBwdWJsaWMgdG9BYnNvbHV0ZU1pbGxpc2Vjb25kcygpOiBudW1iZXIge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmhvdXJzICogUFJJWk1fTUlMTElTRUNPTkRTX0lOX0hPVVIgK1xuICAgICAgdGhpcy5taW51dGVzICogUFJJWk1fTUlMTElTRUNPTkRTX0lOX01JTlVURSArXG4gICAgICB0aGlzLnNlY29uZHMgKiAxMDAwICtcbiAgICAgIHRoaXMubXNcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRUaW1lKHRpbWU6IG51bWJlciwgZGlnaXRzID0gMik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHByaXptUGFkU3RhcnQoU3RyaW5nKHRpbWUpLCBkaWdpdHMsIGAwYCk7XG4gIH1cblxuICBwdWJsaWMgaXNTYW1lVGltZSh0aW1lOiBQcml6bVRpbWUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5tcyA9PT0gdGltZS5tcyAmJlxuICAgICAgdGhpcy5zZWNvbmRzID09PSB0aW1lLnNlY29uZHMgJiZcbiAgICAgIHRoaXMuaG91cnMgPT09IHRpbWUuaG91cnMgJiZcbiAgICAgIHRoaXMubWludXRlcyA9PT0gdGltZS5taW51dGVzXG4gICAgKTtcbiAgfVxufVxuIl19