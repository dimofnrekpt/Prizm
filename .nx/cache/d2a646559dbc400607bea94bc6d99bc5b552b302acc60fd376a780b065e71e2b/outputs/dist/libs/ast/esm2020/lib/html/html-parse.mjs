"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prizmAstHtmlParse = void 0;
const parse_tag_1 = require("./parse-tag");
const prettify_1 = require("./prettify");
// Регулярные выражения для поиска тегов и пробелов
const tagRE = /<[a-zA-Z0-9\-!/](?:"[^"]*"|'[^']*'|[^'">])*>/g;
const whitespaceRE = /^\s*$/;
// Пустой объект для быстрого поиска компонентов
const empty = Object.create(null);
/**
 * Разбирает строку HTML и возвращает массив объектов, представляющих структуру HTML-документа.
 *
 * @param {string} html - Входная строка HTML для разбора.
 * @param {Partial<PrizmHtmlOptions>} [options={}] - Необязательные параметры для настройки разбора HTML.
 * @param {Object} options.components - Объект с компонентами, которые должны быть обработаны особым образом при разборе.
 *
 * @returns {PrizmMaybeHtmlItem[]} Массив объектов, представляющих элементы HTML-документа.
 *
 * @example
 * const htmlString = '<div><p>Hello, world!</p></div>';
 * const result = prizmHtmlParse(htmlString);
 * // Результат: массив объектов, представляющих элементы HTML-документа
 */
const prizmAstHtmlParse = (html, options = {}) => {
    // очищаем от пробелов внтури тегов для правильно работы парсера
    html = (0, prettify_1.prizmAstHtmlPrettify)(html);
    // Инициализация переменных
    options || (options = {});
    options.components || (options.components = empty);
    const result = [];
    const arr = [];
    let current;
    let level = -1;
    let inComponent = false;
    // Обработка текста на верхнем уровне
    if (html.indexOf('<') !== 0) {
        // ... создание текстового узла
        const end = html.indexOf('<');
        result.push({
            type: 'text',
            content: end === -1 ? html : html.substring(0, end),
        });
    }
    // Основной проход по HTML-строке с использованием регулярного выражения
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    html.replace(tagRE, function (tag, index) {
        // Обработка состояний внутри компонента
        if (inComponent) {
            // ... условия и выход из компонента
            if (tag !== '</' + current.name + '>') {
                return '';
            }
            else {
                inComponent = false;
            }
        }
        // Определение открывающегося и комментарного тега
        const isOpen = tag.charAt(1) !== '/';
        const isComment = tag.startsWith('<!--');
        const start = index + tag.length;
        const nextChar = html.charAt(start);
        let parent;
        // Обработка комментария
        if (isComment) {
            // ... создание узла комментария и добавление в родительский элемент
            const comment = (0, parse_tag_1.prizmParseTag)(tag);
            // if we're at root, push new base node
            if (level < 0) {
                result.push(comment);
                return result;
            }
            parent = arr[level];
            if (parent && parent.children && Array.isArray(parent.children)) {
                parent.children.push(comment);
            }
            return result;
        }
        // Обработка открывающегося тега
        if (isOpen) {
            // ... увеличение уровня и разбор тега
            // ... обработка компонентов
            // ... добавление текстового узла внутри тега
            level++;
            current = (0, parse_tag_1.prizmParseTag)(tag);
            if (current.type === 'tag' && current.name && options.components && options.components[current.name]) {
                current.type = 'component';
                inComponent = true;
            }
            if (!current.voidElement &&
                !inComponent &&
                nextChar &&
                nextChar !== '<' &&
                Array.isArray(current.children)) {
                current.children.push({
                    type: 'text',
                    content: html.slice(start, html.indexOf('<', start)),
                });
            }
            // Если находимся на корневом уровне, добавляем новый базовый узел
            if (level === 0) {
                result.push(current);
            }
            // Добавление текущего узла в родительский элемент
            parent = arr[level - 1];
            if (parent && parent.children) {
                parent.children.push(current);
            }
            // Сохранение текущего узла в массиве
            arr[level] = current;
        }
        // Обработка закрывающегося тега или пустого элемента
        if (!isOpen || current.voidElement) {
            // Если текущий элемент пустой или имя текущего элемента совпадает с именем закрывающего тега,
            // уменьшаем уровень и перемещаем current на уровень выше, чтобы соответствовать закрывающему тегу
            if (level > -1 && (current.voidElement || current.name === tag.slice(2, -1))) {
                level--;
                // move current up a level to match the end tag
                current = level === -1 ? result : arr[level];
            }
            // Если мы не внутри компонента и следующий символ не является открывающим тегом, обрабатываем текстовый узел
            if (!inComponent && nextChar !== '<' && nextChar) {
                // Создаем текстовый узел и добавляем его к родительскому элементу
                parent = level === -1 ? result : arr[level].children;
                // Вычисляем правильный конец среза содержимого на случай, если после текстового узла нет тега
                const end = html.indexOf('<', start);
                let content = html.slice(start, end === -1 ? undefined : end);
                // Если узел состоит только из пробелов, сжимаем его в соответствии со спецификацией:
                // https://www.w3.org/TR/html4/struct/text.html#h-9.1
                if (whitespaceRE.test(content)) {
                    content = ' ';
                }
                // Не добавляем текстовые узлы, состоящие только из пробелов, если они являются конечными или начальными текстовыми узлами
                if ((end > -1 && level + parent.length >= 0) || content !== ' ') {
                    if (parent && Array.isArray(parent)) {
                        parent.push({
                            type: 'text',
                            content: content,
                        });
                    }
                }
            }
        }
    });
    // Возвращаем результат разбора HTML
    return result;
};
exports.prizmAstHtmlParse = prizmAstHtmlParse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHRtbC1wYXJzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvYXN0L3NyYy9saWIvaHRtbC9odG1sLXBhcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDJDQUE0QztBQUM1Qyx5Q0FBa0Q7QUFFbEQsbURBQW1EO0FBQ25ELE1BQU0sS0FBSyxHQUFHLCtDQUErQyxDQUFDO0FBQzlELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQztBQUU3QixnREFBZ0Q7QUFDaEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQWVsQzs7Ozs7Ozs7Ozs7OztHQWFHO0FBQ0ksTUFBTSxpQkFBaUIsR0FBRyxDQUFDLElBQVksRUFBRSxVQUFxQyxFQUFFLEVBQU8sRUFBRTtJQUM5RixnRUFBZ0U7SUFDaEUsSUFBSSxHQUFHLElBQUEsK0JBQW9CLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEMsMkJBQTJCO0lBQzNCLE9BQU8sSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMxQixPQUFPLENBQUMsVUFBVSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBeUIsRUFBRSxDQUFDO0lBQ3hDLE1BQU0sR0FBRyxHQUF5QixFQUFFLENBQUM7SUFDckMsSUFBSSxPQUEyQixDQUFDO0lBQ2hDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2YsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDO0lBRXhCLHFDQUFxQztJQUNyQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQzNCLCtCQUErQjtRQUMvQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUM7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LElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDOUQscUZBQXFGO2dCQUNyRixxREFBcUQ7Z0JBQ3JELElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtvQkFDOUIsT0FBTyxHQUFHLEdBQUcsQ0FBQztpQkFDZjtnQkFDRCwwSEFBMEg7Z0JBQzFILElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLElBQUksT0FBTyxLQUFLLEdBQUcsRUFBRTtvQkFDL0QsSUFBSSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDbkMsTUFBTSxDQUFDLElBQUksQ0FBQzs0QkFDVixJQUFJLEVBQUUsTUFBTTs0QkFDWixPQUFPLEVBQUUsT0FBTzt5QkFDakIsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2FBQ0Y7U0FDRjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsb0NBQW9DO0lBQ3BDLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQTdJVyxRQUFBLGlCQUFpQixxQkE2STVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBQcml6bUh0bWxBdHRyLCBQcml6bUh0bWxPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB7IHByaXptUGFyc2VUYWcgfSBmcm9tICcuL3BhcnNlLXRhZyc7XG5pbXBvcnQgeyBwcml6bUFzdEh0bWxQcmV0dGlmeSB9IGZyb20gJy4vcHJldHRpZnknO1xuXG4vLyDQoNC10LPRg9C70Y/RgNC90YvQtSDQstGL0YDQsNC20LXQvdC40Y8g0LTQu9GPINC/0L7QuNGB0LrQsCDRgtC10LPQvtCyINC4INC/0YDQvtCx0LXQu9C+0LJcbmNvbnN0IHRhZ1JFID0gLzxbYS16QS1aMC05XFwtIS9dKD86XCJbXlwiXSpcInwnW14nXSonfFteJ1wiPl0pKj4vZztcbmNvbnN0IHdoaXRlc3BhY2VSRSA9IC9eXFxzKiQvO1xuXG4vLyDQn9GD0YHRgtC+0Lkg0L7QsdGK0LXQutGCINC00LvRjyDQsdGL0YHRgtGA0L7Qs9C+INC/0L7QuNGB0LrQsCDQutC+0LzQv9C+0L3QtdC90YLQvtCyXG5jb25zdCBlbXB0eSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbi8vINCe0L/RgNC10LTQtdC70LXQvdC40LUg0YLQuNC/0LAsINC60L7RgtC+0YDRi9C5INC80L7QttC10YIg0YHQvtC00LXRgNC20LDRgtGMINGB0LLQvtC50YHRgtCy0LAgUHJpem1IdG1sSXRlbSDQuCBQcml6bUh0bWxDb21tZW50XG5pbnRlcmZhY2UgUHJpem1NYXliZUh0bWxJdGVtIHtcbiAgdHlwZT86IHN0cmluZztcbiAgdGV4dD86IHN0cmluZztcbiAgY29udGVudD86IHN0cmluZztcbiAgdm9pZEVsZW1lbnQ/OiBib29sZWFuO1xuICBuYW1lPzogc3RyaW5nO1xuICBzdHlsZT86IHN0cmluZ1tdO1xuICBhdHRycz86IFByaXptSHRtbEF0dHI7XG4gIGNoaWxkcmVuPzogUHJpem1NYXliZUh0bWxJdGVtW107XG4gIGNvbW1lbnQ/OiBzdHJpbmc7XG59XG5cbi8qKlxuICog0KDQsNC30LHQuNGA0LDQtdGCINGB0YLRgNC+0LrRgyBIVE1MINC4INCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINC80LDRgdGB0LjQsiDQvtCx0YrQtdC60YLQvtCyLCDQv9GA0LXQtNGB0YLQsNCy0LvRj9GO0YnQuNGFINGB0YLRgNGD0LrRgtGD0YDRgyBIVE1MLdC00L7QutGD0LzQtdC90YLQsC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gaHRtbCAtINCS0YXQvtC00L3QsNGPINGB0YLRgNC+0LrQsCBIVE1MINC00LvRjyDRgNCw0LfQsdC+0YDQsC5cbiAqIEBwYXJhbSB7UGFydGlhbDxQcml6bUh0bWxPcHRpb25zPn0gW29wdGlvbnM9e31dIC0g0J3QtdC+0LHRj9C30LDRgtC10LvRjNC90YvQtSDQv9Cw0YDQsNC80LXRgtGA0Ysg0LTQu9GPINC90LDRgdGC0YDQvtC50LrQuCDRgNCw0LfQsdC+0YDQsCBIVE1MLlxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMuY29tcG9uZW50cyAtINCe0LHRitC10LrRgiDRgSDQutC+0LzQv9C+0L3QtdC90YLQsNC80LgsINC60L7RgtC+0YDRi9C1INC00L7Qu9C20L3RiyDQsdGL0YLRjCDQvtCx0YDQsNCx0L7RgtCw0L3RiyDQvtGB0L7QsdGL0Lwg0L7QsdGA0LDQt9C+0Lwg0L/RgNC4INGA0LDQt9Cx0L7RgNC1LlxuICpcbiAqIEByZXR1cm5zIHtQcml6bU1heWJlSHRtbEl0ZW1bXX0g0JzQsNGB0YHQuNCyINC+0LHRitC10LrRgtC+0LIsINC/0YDQtdC00YHRgtCw0LLQu9GP0Y7RidC40YUg0Y3Qu9C10LzQtdC90YLRiyBIVE1MLdC00L7QutGD0LzQtdC90YLQsC5cbiAqXG4gKiBAZXhhbXBsZVxuICogY29uc3QgaHRtbFN0cmluZyA9ICc8ZGl2PjxwPkhlbGxvLCB3b3JsZCE8L3A+PC9kaXY+JztcbiAqIGNvbnN0IHJlc3VsdCA9IHByaXptSHRtbFBhcnNlKGh0bWxTdHJpbmcpO1xuICogLy8g0KDQtdC30YPQu9GM0YLQsNGCOiDQvNCw0YHRgdC40LIg0L7QsdGK0LXQutGC0L7Qsiwg0L/RgNC10LTRgdGC0LDQstC70Y/RjtGJ0LjRhSDRjdC70LXQvNC10L3RgtGLIEhUTUwt0LTQvtC60YPQvNC10L3RgtCwXG4gKi9cbmV4cG9ydCBjb25zdCBwcml6bUFzdEh0bWxQYXJzZSA9IChodG1sOiBzdHJpbmcsIG9wdGlvbnM6IFBhcnRpYWw8UHJpem1IdG1sT3B0aW9ucz4gPSB7fSk6IGFueSA9PiB7XG4gIC8vINC+0YfQuNGJ0LDQtdC8INC+0YIg0L/RgNC+0LHQtdC70L7QsiDQstC90YLRg9GA0Lgg0YLQtdCz0L7QsiDQtNC70Y8g0L/RgNCw0LLQuNC70YzQvdC+INGA0LDQsdC+0YLRiyDQv9Cw0YDRgdC10YDQsFxuICBodG1sID0gcHJpem1Bc3RIdG1sUHJldHRpZnkoaHRtbCk7XG4gIC8vINCY0L3QuNGG0LjQsNC70LjQt9Cw0YbQuNGPINC/0LXRgNC10LzQtdC90L3Ri9GFXG4gIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7XG4gIG9wdGlvbnMuY29tcG9uZW50cyB8fCAob3B0aW9ucy5jb21wb25lbnRzID0gZW1wdHkpO1xuICBjb25zdCByZXN1bHQ6IFByaXptTWF5YmVIdG1sSXRlbVtdID0gW107XG4gIGNvbnN0IGFycjogUHJpem1NYXliZUh0bWxJdGVtW10gPSBbXTtcbiAgbGV0IGN1cnJlbnQ6IFByaXptTWF5YmVIdG1sSXRlbTtcbiAgbGV0IGxldmVsID0gLTE7XG4gIGxldCBpbkNvbXBvbmVudCA9IGZhbHNlO1xuXG4gIC8vINCe0LHRgNCw0LHQvtGC0LrQsCDRgtC10LrRgdGC0LAg0L3QsCDQstC10YDRhdC90LXQvCDRg9GA0L7QstC90LVcbiAgaWYgKGh0bWwuaW5kZXhPZignPCcpICE9PSAwKSB7XG4gICAgLy8gLi4uINGB0L7Qt9C00LDQvdC40LUg0YLQtdC60YHRgtC+0LLQvtCz0L4g0YPQt9C70LBcbiAgICBjb25zdCBlbmQgPSBodG1sLmluZGV4T2YoJzwnKTtcbiAgICByZXN1bHQucHVzaCh7XG4gICAgICB0eXBlOiAndGV4dCcsXG4gICAgICBjb250ZW50OiBlbmQgPT09IC0xID8gaHRtbCA6IGh0bWwuc3Vic3RyaW5nKDAsIGVuZCksXG4gICAgfSk7XG4gIH1cblxuICAvLyDQntGB0L3QvtCy0L3QvtC5INC/0YDQvtGF0L7QtCDQv9C+IEhUTUwt0YHRgtGA0L7QutC1INGBINC40YHQv9C+0LvRjNC30L7QstCw0L3QuNC10Lwg0YDQtdCz0YPQu9GP0YDQvdC+0LPQviDQstGL0YDQsNC20LXQvdC40Y9cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAvLyBAdHMtaWdub3JlXG4gIGh0bWwucmVwbGFjZSh0YWdSRSwgZnVuY3Rpb24gKHRhZywgaW5kZXgpIHtcbiAgICAvLyDQntCx0YDQsNCx0L7RgtC60LAg0YHQvtGB0YLQvtGP0L3QuNC5INCy0L3Rg9GC0YDQuCDQutC+0LzQv9C+0L3QtdC90YLQsFxuICAgIGlmIChpbkNvbXBvbmVudCkge1xuICAgICAgLy8gLi4uINGD0YHQu9C+0LLQuNGPINC4INCy0YvRhdC+0LQg0LjQtyDQutC+0LzQv9C+0L3QtdC90YLQsFxuICAgICAgaWYgKHRhZyAhPT0gJzwvJyArIGN1cnJlbnQubmFtZSArICc+Jykge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbkNvbXBvbmVudCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vINCe0L/RgNC10LTQtdC70LXQvdC40LUg0L7RgtC60YDRi9Cy0LDRjtGJ0LXQs9C+0YHRjyDQuCDQutC+0LzQvNC10L3RgtCw0YDQvdC+0LPQviDRgtC10LPQsFxuICAgIGNvbnN0IGlzT3BlbiA9IHRhZy5jaGFyQXQoMSkgIT09ICcvJztcbiAgICBjb25zdCBpc0NvbW1lbnQgPSB0YWcuc3RhcnRzV2l0aCgnPCEtLScpO1xuICAgIGNvbnN0IHN0YXJ0ID0gaW5kZXggKyB0YWcubGVuZ3RoO1xuICAgIGNvbnN0IG5leHRDaGFyID0gaHRtbC5jaGFyQXQoc3RhcnQpO1xuXG4gICAgbGV0IHBhcmVudDogUHJpem1NYXliZUh0bWxJdGVtIHwgUHJpem1NYXliZUh0bWxJdGVtWydjaGlsZHJlbiddO1xuXG4gICAgLy8g0J7QsdGA0LDQsdC+0YLQutCwINC60L7QvNC80LXQvdGC0LDRgNC40Y9cbiAgICBpZiAoaXNDb21tZW50KSB7XG4gICAgICAvLyAuLi4g0YHQvtC30LTQsNC90LjQtSDRg9C30LvQsCDQutC+0LzQvNC10L3RgtCw0YDQuNGPINC4INC00L7QsdCw0LLQu9C10L3QuNC1INCyINGA0L7QtNC40YLQtdC70YzRgdC60LjQuSDRjdC70LXQvNC10L3RglxuICAgICAgY29uc3QgY29tbWVudCA9IHByaXptUGFyc2VUYWcodGFnKTtcblxuICAgICAgLy8gaWYgd2UncmUgYXQgcm9vdCwgcHVzaCBuZXcgYmFzZSBub2RlXG4gICAgICBpZiAobGV2ZWwgPCAwKSB7XG4gICAgICAgIHJlc3VsdC5wdXNoKGNvbW1lbnQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuICAgICAgcGFyZW50ID0gYXJyW2xldmVsXTtcbiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LmNoaWxkcmVuICYmIEFycmF5LmlzQXJyYXkocGFyZW50LmNoaWxkcmVuKSkge1xuICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChjb21tZW50KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLy8g0J7QsdGA0LDQsdC+0YLQutCwINC+0YLQutGA0YvQstCw0Y7RidC10LPQvtGB0Y8g0YLQtdCz0LBcbiAgICBpZiAoaXNPcGVuKSB7XG4gICAgICAvLyAuLi4g0YPQstC10LvQuNGH0LXQvdC40LUg0YPRgNC+0LLQvdGPINC4INGA0LDQt9Cx0L7RgCDRgtC10LPQsFxuICAgICAgLy8gLi4uINC+0LHRgNCw0LHQvtGC0LrQsCDQutC+0LzQv9C+0L3QtdC90YLQvtCyXG4gICAgICAvLyAuLi4g0LTQvtCx0LDQstC70LXQvdC40LUg0YLQtdC60YHRgtC+0LLQvtCz0L4g0YPQt9C70LAg0LLQvdGD0YLRgNC4INGC0LXQs9CwXG5cbiAgICAgIGxldmVsKys7XG5cbiAgICAgIGN1cnJlbnQgPSBwcml6bVBhcnNlVGFnKHRhZyk7XG4gICAgICBpZiAoY3VycmVudC50eXBlID09PSAndGFnJyAmJiBjdXJyZW50Lm5hbWUgJiYgb3B0aW9ucy5jb21wb25lbnRzICYmIG9wdGlvbnMuY29tcG9uZW50c1tjdXJyZW50Lm5hbWVdKSB7XG4gICAgICAgIGN1cnJlbnQudHlwZSA9ICdjb21wb25lbnQnO1xuICAgICAgICBpbkNvbXBvbmVudCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChcbiAgICAgICAgIWN1cnJlbnQudm9pZEVsZW1lbnQgJiZcbiAgICAgICAgIWluQ29tcG9uZW50ICYmXG4gICAgICAgIG5leHRDaGFyICYmXG4gICAgICAgIG5leHRDaGFyICE9PSAnPCcgJiZcbiAgICAgICAgQXJyYXkuaXNBcnJheShjdXJyZW50LmNoaWxkcmVuKVxuICAgICAgKSB7XG4gICAgICAgIGN1cnJlbnQuY2hpbGRyZW4ucHVzaCh7XG4gICAgICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgICAgIGNvbnRlbnQ6IGh0bWwuc2xpY2Uoc3RhcnQsIGh0bWwuaW5kZXhPZignPCcsIHN0YXJ0KSksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyDQldGB0LvQuCDQvdCw0YXQvtC00LjQvNGB0Y8g0L3QsCDQutC+0YDQvdC10LLQvtC8INGD0YDQvtCy0L3QtSwg0LTQvtCx0LDQstC70Y/QtdC8INC90L7QstGL0Lkg0LHQsNC30L7QstGL0Lkg0YPQt9C10LtcbiAgICAgIGlmIChsZXZlbCA9PT0gMCkge1xuICAgICAgICByZXN1bHQucHVzaChjdXJyZW50KTtcbiAgICAgIH1cblxuICAgICAgLy8g0JTQvtCx0LDQstC70LXQvdC40LUg0YLQtdC60YPRidC10LPQviDRg9C30LvQsCDQsiDRgNC+0LTQuNGC0LXQu9GM0YHQutC40Lkg0Y3Qu9C10LzQtdC90YJcbiAgICAgIHBhcmVudCA9IGFycltsZXZlbCAtIDFdO1xuXG4gICAgICBpZiAocGFyZW50ICYmIHBhcmVudC5jaGlsZHJlbikge1xuICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChjdXJyZW50KTtcbiAgICAgIH1cblxuICAgICAgLy8g0KHQvtGF0YDQsNC90LXQvdC40LUg0YLQtdC60YPRidC10LPQviDRg9C30LvQsCDQsiDQvNCw0YHRgdC40LLQtVxuICAgICAgYXJyW2xldmVsXSA9IGN1cnJlbnQ7XG4gICAgfVxuXG4gICAgLy8g0J7QsdGA0LDQsdC+0YLQutCwINC30LDQutGA0YvQstCw0Y7RidC10LPQvtGB0Y8g0YLQtdCz0LAg0LjQu9C4INC/0YPRgdGC0L7Qs9C+INGN0LvQtdC80LXQvdGC0LBcbiAgICBpZiAoIWlzT3BlbiB8fCBjdXJyZW50LnZvaWRFbGVtZW50KSB7XG4gICAgICAvLyDQldGB0LvQuCDRgtC10LrRg9GJ0LjQuSDRjdC70LXQvNC10L3RgiDQv9GD0YHRgtC+0Lkg0LjQu9C4INC40LzRjyDRgtC10LrRg9GJ0LXQs9C+INGN0LvQtdC80LXQvdGC0LAg0YHQvtCy0L/QsNC00LDQtdGCINGBINC40LzQtdC90LXQvCDQt9Cw0LrRgNGL0LLQsNGO0YnQtdCz0L4g0YLQtdCz0LAsXG4gICAgICAvLyDRg9C80LXQvdGM0YjQsNC10Lwg0YPRgNC+0LLQtdC90Ywg0Lgg0L/QtdGA0LXQvNC10YnQsNC10LwgY3VycmVudCDQvdCwINGD0YDQvtCy0LXQvdGMINCy0YvRiNC1LCDRh9GC0L7QsdGLINGB0L7QvtGC0LLQtdGC0YHRgtCy0L7QstCw0YLRjCDQt9Cw0LrRgNGL0LLQsNGO0YnQtdC80YMg0YLQtdCz0YNcbiAgICAgIGlmIChsZXZlbCA+IC0xICYmIChjdXJyZW50LnZvaWRFbGVtZW50IHx8IGN1cnJlbnQubmFtZSA9PT0gdGFnLnNsaWNlKDIsIC0xKSkpIHtcbiAgICAgICAgbGV2ZWwtLTtcbiAgICAgICAgLy8gbW92ZSBjdXJyZW50IHVwIGEgbGV2ZWwgdG8gbWF0Y2ggdGhlIGVuZCB0YWdcbiAgICAgICAgY3VycmVudCA9IGxldmVsID09PSAtMSA/IChyZXN1bHQgYXMgUHJpem1NYXliZUh0bWxJdGVtKSA6IGFycltsZXZlbF07XG4gICAgICB9XG4gICAgICAvLyDQldGB0LvQuCDQvNGLINC90LUg0LLQvdGD0YLRgNC4INC60L7QvNC/0L7QvdC10L3RgtCwINC4INGB0LvQtdC00YPRjtGJ0LjQuSDRgdC40LzQstC+0Lsg0L3QtSDRj9Cy0LvRj9C10YLRgdGPINC+0YLQutGA0YvQstCw0Y7RidC40Lwg0YLQtdCz0L7QvCwg0L7QsdGA0LDQsdCw0YLRi9Cy0LDQtdC8INGC0LXQutGB0YLQvtCy0YvQuSDRg9C30LXQu1xuICAgICAgaWYgKCFpbkNvbXBvbmVudCAmJiBuZXh0Q2hhciAhPT0gJzwnICYmIG5leHRDaGFyKSB7XG4gICAgICAgIC8vINCh0L7Qt9C00LDQtdC8INGC0LXQutGB0YLQvtCy0YvQuSDRg9C30LXQuyDQuCDQtNC+0LHQsNCy0LvRj9C10Lwg0LXQs9C+INC6INGA0L7QtNC40YLQtdC70YzRgdC60L7QvNGDINGN0LvQtdC80LXQvdGC0YNcbiAgICAgICAgcGFyZW50ID0gbGV2ZWwgPT09IC0xID8gcmVzdWx0IDogKGFycltsZXZlbF0uY2hpbGRyZW4gYXMgUHJpem1NYXliZUh0bWxJdGVtW10pO1xuXG4gICAgICAgIC8vINCS0YvRh9C40YHQu9GP0LXQvCDQv9GA0LDQstC40LvRjNC90YvQuSDQutC+0L3QtdGGINGB0YDQtdC30LAg0YHQvtC00LXRgNC20LjQvNC+0LPQviDQvdCwINGB0LvRg9GH0LDQuSwg0LXRgdC70Lgg0L/QvtGB0LvQtSDRgtC10LrRgdGC0L7QstC+0LPQviDRg9C30LvQsCDQvdC10YIg0YLQtdCz0LBcbiAgICAgICAgY29uc3QgZW5kID0gaHRtbC5pbmRleE9mKCc8Jywgc3RhcnQpO1xuICAgICAgICBsZXQgY29udGVudCA9IGh0bWwuc2xpY2Uoc3RhcnQsIGVuZCA9PT0gLTEgPyB1bmRlZmluZWQgOiBlbmQpO1xuICAgICAgICAvLyDQldGB0LvQuCDRg9C30LXQuyDRgdC+0YHRgtC+0LjRgiDRgtC+0LvRjNC60L4g0LjQtyDQv9GA0L7QsdC10LvQvtCyLCDRgdC20LjQvNCw0LXQvCDQtdCz0L4g0LIg0YHQvtC+0YLQstC10YLRgdGC0LLQuNC4INGB0L4g0YHQv9C10YbQuNGE0LjQutCw0YbQuNC10Lk6XG4gICAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9odG1sNC9zdHJ1Y3QvdGV4dC5odG1sI2gtOS4xXG4gICAgICAgIGlmICh3aGl0ZXNwYWNlUkUudGVzdChjb250ZW50KSkge1xuICAgICAgICAgIGNvbnRlbnQgPSAnICc7XG4gICAgICAgIH1cbiAgICAgICAgLy8g0J3QtSDQtNC+0LHQsNCy0LvRj9C10Lwg0YLQtdC60YHRgtC+0LLRi9C1INGD0LfQu9GLLCDRgdC+0YHRgtC+0Y/RidC40LUg0YLQvtC70YzQutC+INC40Lcg0L/RgNC+0LHQtdC70L7Qsiwg0LXRgdC70Lgg0L7QvdC4INGP0LLQu9GP0Y7RgtGB0Y8g0LrQvtC90LXRh9C90YvQvNC4INC40LvQuCDQvdCw0YfQsNC70YzQvdGL0LzQuCDRgtC10LrRgdGC0L7QstGL0LzQuCDRg9C30LvQsNC80LhcbiAgICAgICAgaWYgKChlbmQgPiAtMSAmJiBsZXZlbCArIHBhcmVudC5sZW5ndGggPj0gMCkgfHwgY29udGVudCAhPT0gJyAnKSB7XG4gICAgICAgICAgaWYgKHBhcmVudCAmJiBBcnJheS5pc0FycmF5KHBhcmVudCkpIHtcbiAgICAgICAgICAgIHBhcmVudC5wdXNoKHtcbiAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgICAgICAgICBjb250ZW50OiBjb250ZW50LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICAvLyDQktC+0LfQstGA0LDRidCw0LXQvCDRgNC10LfRg9C70YzRgtCw0YIg0YDQsNC30LHQvtGA0LAgSFRNTFxuICByZXR1cm4gcmVzdWx0O1xufTtcbiJdfQ==