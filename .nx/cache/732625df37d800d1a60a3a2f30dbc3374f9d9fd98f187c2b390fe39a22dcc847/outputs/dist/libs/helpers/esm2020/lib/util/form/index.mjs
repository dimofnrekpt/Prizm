import { concat, EMPTY, mapTo, merge, of, timer } from 'rxjs';
import { filter, first, map, tap } from 'rxjs/operators';
export class PrizmFormControlHelpers {
    static getDisabled$(origin) {
        return origin.statusChanges.pipe(map(() => this.getDisabled(origin)));
    }
    static getValidators$(origin) {
        return origin.statusChanges.pipe(map(() => this.getValidators(origin)));
    }
    static getAsyncValidators$(origin) {
        return origin.statusChanges.pipe(map(() => this.getAsyncValidators(origin)));
    }
    static getValue$(origin) {
        return origin.valueChanges.pipe(map(() => this.getValue(origin)));
    }
    static getDisabled(origin) {
        return origin.disabled;
    }
    static isTouched(origin) {
        return origin.touched;
    }
    static isDirty(origin) {
        return origin.dirty;
    }
    static getValidators(origin) {
        return origin?.['_rawValidators'] ?? null;
    }
    static getAsyncValidators(origin) {
        return origin?.['_rawAsyncValidators'] ?? null;
    }
    static getValue(origin) {
        return origin.value;
    }
    static syncStates(origin, bidirectional, ...others) {
        const all = [origin, ...others];
        return concat(timer(0).pipe(map(() => origin)), bidirectional
            ? merge(...all.map(control => control.statusChanges.pipe(mapTo(control))))
            : origin.statusChanges.pipe(mapTo(origin))).pipe(map(origin => {
            (bidirectional ? all : others).forEach(control => {
                const disabled = this.getDisabled(origin);
                if (disabled === control.disabled)
                    return;
                if (disabled) {
                    control.disable();
                }
                else {
                    control.enable();
                }
                this.syncControlVisualStates(origin, control);
            });
            return this.getDisabled(origin);
        }));
    }
    static syncValidators(origin, bidirectional, ...others) {
        const all = [origin, ...others];
        return concat(of(this.getValidators(origin)), bidirectional ? merge(...all.map(control => this.getValidators$(control))) : this.getValidators$(origin)).pipe(tap(validators => {
            (bidirectional ? all : others).forEach(control => {
                control.setValidators(validators);
            });
        }));
    }
    static syncAllValidators(origin, bidirectional, ...others) {
        return merge(this.syncValidators(origin, bidirectional, ...others), this.syncAsyncValidators(origin, bidirectional, ...others));
    }
    static syncAsyncValidators(origin, bidirectional, ...others) {
        const all = [origin, ...others];
        return concat(of(this.getAsyncValidators(origin)), bidirectional
            ? merge(...all.map(control => this.getAsyncValidators$(control)))
            : this.getAsyncValidators$(origin)).pipe(tap(asyncValidators => {
            (bidirectional ? all : others).forEach(control => {
                control.setAsyncValidators(asyncValidators);
            });
        }));
    }
    static setValue(control, newValue, options) {
        const currentValue = this.getValue(control);
        if (currentValue === newValue)
            return;
        control.setValue(newValue, options);
    }
    static setDisabled(control, disabled, options) {
        if (disabled === control.disabled)
            return;
        if (!disabled)
            control.enable(options);
        else
            control.disable(options);
    }
    static syncControlVisualStates(control, other) {
        if (control.pristine)
            other.markAsPristine();
        if (control.dirty)
            other.markAsDirty();
        if (control.touched)
            other.markAsTouched();
        if (control.untouched)
            other.markAsUntouched();
        if (control.pending)
            other.markAsPending();
    }
    static syncValues(origin, fromOrigin, fromOthers, ...others) {
        return merge(timer(0).pipe(first(), map(() => this.getValue(origin)), tap((valueFromOrigin) => {
            const value = fromOrigin(valueFromOrigin);
            others.forEach(control => {
                this.setValue(control, value);
                this.syncControlVisualStates(origin, control);
            });
        })), this.getValue$(origin).pipe(filter(() => Boolean(fromOrigin)), tap((valueFromOrigin) => {
            const value = fromOrigin(valueFromOrigin);
            others.forEach(control => {
                this.setValue(control, value);
                this.syncControlVisualStates(origin, control);
            });
        })), fromOthers
            ? merge(...others.map(control => this.getValue$(control))).pipe(filter(() => Boolean(fromOthers)), tap((valueFromOther) => {
                const value = fromOthers(valueFromOther);
                this.setValue(origin, value);
            }))
            : EMPTY).pipe(map(() => this.getValue(origin)));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2hlbHBlcnMvc3JjL2xpYi91dGlsL2Zvcm0vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RCxNQUFNLE9BQU8sdUJBQXVCO0lBQzNCLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBMEI7UUFDbkQsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUNNLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBMEI7UUFDckQsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUNNLE1BQU0sQ0FBQyxtQkFBbUIsQ0FDL0IsTUFBMEI7UUFFMUIsT0FBTyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRU0sTUFBTSxDQUFDLFNBQVMsQ0FBVSxNQUEwQjtRQUN6RCxPQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRU0sTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUEwQjtRQUNsRCxPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUNNLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBMEI7UUFDaEQsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFDTSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQTBCO1FBQzlDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRU0sTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUEwQjtRQUNwRCxPQUFRLE1BQWMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksSUFBSSxDQUFDO0lBQ3JELENBQUM7SUFFTSxNQUFNLENBQUMsa0JBQWtCLENBQUMsTUFBMEI7UUFDekQsT0FBUSxNQUFjLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUMxRCxDQUFDO0lBRU0sTUFBTSxDQUFDLFFBQVEsQ0FBSSxNQUEwQjtRQUNsRCxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxVQUFVLENBQ3RCLE1BQTBCLEVBQzFCLGFBQXNCLEVBQ3RCLEdBQUcsTUFBNEI7UUFFL0IsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUNoQyxPQUFPLE1BQU0sQ0FDWCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUNoQyxhQUFhO1lBQ1gsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFFLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDN0MsQ0FBQyxJQUFJLENBQ0osR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ1gsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLFFBQVEsS0FBSyxPQUFPLENBQUMsUUFBUTtvQkFBRSxPQUFPO2dCQUMxQyxJQUFJLFFBQVEsRUFBRTtvQkFDWixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7aUJBQ25CO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDbEI7Z0JBQ0QsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNoRCxDQUFDLENBQUMsQ0FBQztZQUVILE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVNLE1BQU0sQ0FBQyxjQUFjLENBQzFCLE1BQTBCLEVBQzFCLGFBQXNCLEVBQ3RCLEdBQUcsTUFBNEI7UUFFL0IsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUNoQyxPQUFPLE1BQU0sQ0FDWCxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUM5QixhQUFhLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FDekcsQ0FBQyxJQUFJLENBQ0osR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2YsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUMvQyxPQUFPLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3BDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTSxNQUFNLENBQUMsaUJBQWlCLENBQzdCLE1BQTBCLEVBQzFCLGFBQXNCLEVBQ3RCLEdBQUcsTUFBNEI7UUFFL0IsT0FBTyxLQUFLLENBQ1YsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFDLEVBQ3JELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQzNELENBQUM7SUFDSixDQUFDO0lBRU0sTUFBTSxDQUFDLG1CQUFtQixDQUMvQixNQUEwQixFQUMxQixhQUFzQixFQUN0QixHQUFHLE1BQTRCO1FBRS9CLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLENBQUM7UUFDaEMsT0FBTyxNQUFNLENBQ1gsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUNuQyxhQUFhO1lBQ1gsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNqRSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUNyQyxDQUFDLElBQUksQ0FDSixHQUFHLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDcEIsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUMvQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDOUMsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVNLE1BQU0sQ0FBQyxRQUFRLENBQ3BCLE9BQTJCLEVBQzNCLFFBQVcsRUFDWCxPQUtDO1FBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBSSxPQUFPLENBQUMsQ0FBQztRQUMvQyxJQUFJLFlBQVksS0FBSyxRQUFRO1lBQUUsT0FBTztRQUN0QyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU0sTUFBTSxDQUFDLFdBQVcsQ0FDdkIsT0FBMkIsRUFDM0IsUUFBaUIsRUFDakIsT0FHQztRQUVELElBQUksUUFBUSxLQUFLLE9BQU8sQ0FBQyxRQUFRO1lBQUUsT0FBTztRQUMxQyxJQUFJLENBQUMsUUFBUTtZQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7O1lBQ2xDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVNLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxPQUEyQixFQUFFLEtBQXlCO1FBQzFGLElBQUksT0FBTyxDQUFDLFFBQVE7WUFBRSxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDN0MsSUFBSSxPQUFPLENBQUMsS0FBSztZQUFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN2QyxJQUFJLE9BQU8sQ0FBQyxPQUFPO1lBQUUsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQzNDLElBQUksT0FBTyxDQUFDLFNBQVM7WUFBRSxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDL0MsSUFBSSxPQUFPLENBQUMsT0FBTztZQUFFLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0lBRU0sTUFBTSxDQUFDLFVBQVUsQ0FDdEIsTUFBMEIsRUFDMUIsVUFBMEQsRUFDMUQsVUFBa0UsRUFDbEUsR0FBRyxNQUE0QjtRQUUvQixPQUFPLEtBQUssQ0FDVixLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNYLEtBQUssRUFBRSxFQUNQLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBaUIsQ0FBQyxFQUNoRCxHQUFHLENBQUMsQ0FBQyxlQUE2QixFQUFFLEVBQUU7WUFDcEMsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM5QixJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQ0gsRUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDekIsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUNqQyxHQUFHLENBQUMsQ0FBQyxlQUE2QixFQUFFLEVBQUU7WUFDcEMsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM5QixJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQ0gsRUFDRCxVQUFVO1lBQ1IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQzNELE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsRUFDakMsR0FBRyxDQUFDLENBQUMsY0FBMkIsRUFBRSxFQUFFO2dCQUNsQyxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9CLENBQUMsQ0FBQyxDQUNIO1lBQ0gsQ0FBQyxDQUFDLEtBQUssQ0FDVixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXN5bmNWYWxpZGF0b3JGbiwgVW50eXBlZEZvcm1Db250cm9sLCBWYWxpZGF0b3JGbiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IGNvbmNhdCwgRU1QVFksIG1hcFRvLCBtZXJnZSwgT2JzZXJ2YWJsZSwgb2YsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIGZpcnN0LCBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IGNsYXNzIFByaXptRm9ybUNvbnRyb2xIZWxwZXJzIHtcbiAgcHVibGljIHN0YXRpYyBnZXREaXNhYmxlZCQob3JpZ2luOiBVbnR5cGVkRm9ybUNvbnRyb2wpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gb3JpZ2luLnN0YXR1c0NoYW5nZXMucGlwZShtYXAoKCkgPT4gdGhpcy5nZXREaXNhYmxlZChvcmlnaW4pKSk7XG4gIH1cbiAgcHVibGljIHN0YXRpYyBnZXRWYWxpZGF0b3JzJChvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCk6IE9ic2VydmFibGU8VmFsaWRhdG9yRm4gfCBWYWxpZGF0b3JGbltdIHwgbnVsbD4ge1xuICAgIHJldHVybiBvcmlnaW4uc3RhdHVzQ2hhbmdlcy5waXBlKG1hcCgoKSA9PiB0aGlzLmdldFZhbGlkYXRvcnMob3JpZ2luKSkpO1xuICB9XG4gIHB1YmxpYyBzdGF0aWMgZ2V0QXN5bmNWYWxpZGF0b3JzJChcbiAgICBvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbFxuICApOiBPYnNlcnZhYmxlPEFzeW5jVmFsaWRhdG9yRm4gfCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPiB7XG4gICAgcmV0dXJuIG9yaWdpbi5zdGF0dXNDaGFuZ2VzLnBpcGUobWFwKCgpID0+IHRoaXMuZ2V0QXN5bmNWYWxpZGF0b3JzKG9yaWdpbikpKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0VmFsdWUkPFQgPSBhbnk+KG9yaWdpbjogVW50eXBlZEZvcm1Db250cm9sKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIG9yaWdpbi52YWx1ZUNoYW5nZXMucGlwZShtYXAoKCkgPT4gdGhpcy5nZXRWYWx1ZTxUPihvcmlnaW4pKSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldERpc2FibGVkKG9yaWdpbjogVW50eXBlZEZvcm1Db250cm9sKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9yaWdpbi5kaXNhYmxlZDtcbiAgfVxuICBwdWJsaWMgc3RhdGljIGlzVG91Y2hlZChvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvcmlnaW4udG91Y2hlZDtcbiAgfVxuICBwdWJsaWMgc3RhdGljIGlzRGlydHkob3JpZ2luOiBVbnR5cGVkRm9ybUNvbnRyb2wpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb3JpZ2luLmRpcnR5O1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRWYWxpZGF0b3JzKG9yaWdpbjogVW50eXBlZEZvcm1Db250cm9sKTogVmFsaWRhdG9yRm4gfCBWYWxpZGF0b3JGbltdIHwgbnVsbCB7XG4gICAgcmV0dXJuIChvcmlnaW4gYXMgYW55KT8uWydfcmF3VmFsaWRhdG9ycyddID8/IG51bGw7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldEFzeW5jVmFsaWRhdG9ycyhvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCk6IEFzeW5jVmFsaWRhdG9yRm4gfCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsIHtcbiAgICByZXR1cm4gKG9yaWdpbiBhcyBhbnkpPy5bJ19yYXdBc3luY1ZhbGlkYXRvcnMnXSA/PyBudWxsO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRWYWx1ZTxUPihvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCk6IFQge1xuICAgIHJldHVybiBvcmlnaW4udmFsdWU7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHN5bmNTdGF0ZXMoXG4gICAgb3JpZ2luOiBVbnR5cGVkRm9ybUNvbnRyb2wsXG4gICAgYmlkaXJlY3Rpb25hbDogYm9vbGVhbixcbiAgICAuLi5vdGhlcnM6IFVudHlwZWRGb3JtQ29udHJvbFtdXG4gICk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGFsbCA9IFtvcmlnaW4sIC4uLm90aGVyc107XG4gICAgcmV0dXJuIGNvbmNhdChcbiAgICAgIHRpbWVyKDApLnBpcGUobWFwKCgpID0+IG9yaWdpbikpLFxuICAgICAgYmlkaXJlY3Rpb25hbFxuICAgICAgICA/IG1lcmdlKC4uLmFsbC5tYXAoY29udHJvbCA9PiBjb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShtYXBUbyhjb250cm9sKSkpKVxuICAgICAgICA6IG9yaWdpbi5zdGF0dXNDaGFuZ2VzLnBpcGUobWFwVG8ob3JpZ2luKSlcbiAgICApLnBpcGUoXG4gICAgICBtYXAob3JpZ2luID0+IHtcbiAgICAgICAgKGJpZGlyZWN0aW9uYWwgPyBhbGwgOiBvdGhlcnMpLmZvckVhY2goY29udHJvbCA9PiB7XG4gICAgICAgICAgY29uc3QgZGlzYWJsZWQgPSB0aGlzLmdldERpc2FibGVkKG9yaWdpbik7XG4gICAgICAgICAgaWYgKGRpc2FibGVkID09PSBjb250cm9sLmRpc2FibGVkKSByZXR1cm47XG4gICAgICAgICAgaWYgKGRpc2FibGVkKSB7XG4gICAgICAgICAgICBjb250cm9sLmRpc2FibGUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udHJvbC5lbmFibGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5zeW5jQ29udHJvbFZpc3VhbFN0YXRlcyhvcmlnaW4sIGNvbnRyb2wpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5nZXREaXNhYmxlZChvcmlnaW4pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzeW5jVmFsaWRhdG9ycyhcbiAgICBvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCxcbiAgICBiaWRpcmVjdGlvbmFsOiBib29sZWFuLFxuICAgIC4uLm90aGVyczogVW50eXBlZEZvcm1Db250cm9sW11cbiAgKTogT2JzZXJ2YWJsZTxWYWxpZGF0b3JGbiB8IFZhbGlkYXRvckZuW10gfCBudWxsPiB7XG4gICAgY29uc3QgYWxsID0gW29yaWdpbiwgLi4ub3RoZXJzXTtcbiAgICByZXR1cm4gY29uY2F0KFxuICAgICAgb2YodGhpcy5nZXRWYWxpZGF0b3JzKG9yaWdpbikpLFxuICAgICAgYmlkaXJlY3Rpb25hbCA/IG1lcmdlKC4uLmFsbC5tYXAoY29udHJvbCA9PiB0aGlzLmdldFZhbGlkYXRvcnMkKGNvbnRyb2wpKSkgOiB0aGlzLmdldFZhbGlkYXRvcnMkKG9yaWdpbilcbiAgICApLnBpcGUoXG4gICAgICB0YXAodmFsaWRhdG9ycyA9PiB7XG4gICAgICAgIChiaWRpcmVjdGlvbmFsID8gYWxsIDogb3RoZXJzKS5mb3JFYWNoKGNvbnRyb2wgPT4ge1xuICAgICAgICAgIGNvbnRyb2wuc2V0VmFsaWRhdG9ycyh2YWxpZGF0b3JzKTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHN5bmNBbGxWYWxpZGF0b3JzKFxuICAgIG9yaWdpbjogVW50eXBlZEZvcm1Db250cm9sLFxuICAgIGJpZGlyZWN0aW9uYWw6IGJvb2xlYW4sXG4gICAgLi4ub3RoZXJzOiBVbnR5cGVkRm9ybUNvbnRyb2xbXVxuICApOiBPYnNlcnZhYmxlPFZhbGlkYXRvckZuIHwgVmFsaWRhdG9yRm5bXSB8IEFzeW5jVmFsaWRhdG9yRm4gfCBBc3luY1ZhbGlkYXRvckZuW10gfCBudWxsPiB7XG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgdGhpcy5zeW5jVmFsaWRhdG9ycyhvcmlnaW4sIGJpZGlyZWN0aW9uYWwsIC4uLm90aGVycyksXG4gICAgICB0aGlzLnN5bmNBc3luY1ZhbGlkYXRvcnMob3JpZ2luLCBiaWRpcmVjdGlvbmFsLCAuLi5vdGhlcnMpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc3luY0FzeW5jVmFsaWRhdG9ycyhcbiAgICBvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCxcbiAgICBiaWRpcmVjdGlvbmFsOiBib29sZWFuLFxuICAgIC4uLm90aGVyczogVW50eXBlZEZvcm1Db250cm9sW11cbiAgKTogT2JzZXJ2YWJsZTxBc3luY1ZhbGlkYXRvckZuIHwgQXN5bmNWYWxpZGF0b3JGbltdIHwgbnVsbD4ge1xuICAgIGNvbnN0IGFsbCA9IFtvcmlnaW4sIC4uLm90aGVyc107XG4gICAgcmV0dXJuIGNvbmNhdChcbiAgICAgIG9mKHRoaXMuZ2V0QXN5bmNWYWxpZGF0b3JzKG9yaWdpbikpLFxuICAgICAgYmlkaXJlY3Rpb25hbFxuICAgICAgICA/IG1lcmdlKC4uLmFsbC5tYXAoY29udHJvbCA9PiB0aGlzLmdldEFzeW5jVmFsaWRhdG9ycyQoY29udHJvbCkpKVxuICAgICAgICA6IHRoaXMuZ2V0QXN5bmNWYWxpZGF0b3JzJChvcmlnaW4pXG4gICAgKS5waXBlKFxuICAgICAgdGFwKGFzeW5jVmFsaWRhdG9ycyA9PiB7XG4gICAgICAgIChiaWRpcmVjdGlvbmFsID8gYWxsIDogb3RoZXJzKS5mb3JFYWNoKGNvbnRyb2wgPT4ge1xuICAgICAgICAgIGNvbnRyb2wuc2V0QXN5bmNWYWxpZGF0b3JzKGFzeW5jVmFsaWRhdG9ycyk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzZXRWYWx1ZTxUID0gYW55PihcbiAgICBjb250cm9sOiBVbnR5cGVkRm9ybUNvbnRyb2wsXG4gICAgbmV3VmFsdWU6IFQsXG4gICAgb3B0aW9ucz86IHtcbiAgICAgIG9ubHlTZWxmPzogYm9vbGVhbjtcbiAgICAgIGVtaXRFdmVudD86IGJvb2xlYW47XG4gICAgICBlbWl0TW9kZWxUb1ZpZXdDaGFuZ2U/OiBib29sZWFuO1xuICAgICAgZW1pdFZpZXdUb01vZGVsQ2hhbmdlPzogYm9vbGVhbjtcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWU8VD4oY29udHJvbCk7XG4gICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gbmV3VmFsdWUpIHJldHVybjtcbiAgICBjb250cm9sLnNldFZhbHVlKG5ld1ZhbHVlLCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc2V0RGlzYWJsZWQoXG4gICAgY29udHJvbDogVW50eXBlZEZvcm1Db250cm9sLFxuICAgIGRpc2FibGVkOiBib29sZWFuLFxuICAgIG9wdGlvbnM/OiB7XG4gICAgICBvbmx5U2VsZj86IGJvb2xlYW47XG4gICAgICBlbWl0RXZlbnQ/OiBib29sZWFuO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgaWYgKGRpc2FibGVkID09PSBjb250cm9sLmRpc2FibGVkKSByZXR1cm47XG4gICAgaWYgKCFkaXNhYmxlZCkgY29udHJvbC5lbmFibGUob3B0aW9ucyk7XG4gICAgZWxzZSBjb250cm9sLmRpc2FibGUob3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHN5bmNDb250cm9sVmlzdWFsU3RhdGVzKGNvbnRyb2w6IFVudHlwZWRGb3JtQ29udHJvbCwgb3RoZXI6IFVudHlwZWRGb3JtQ29udHJvbCk6IHZvaWQge1xuICAgIGlmIChjb250cm9sLnByaXN0aW5lKSBvdGhlci5tYXJrQXNQcmlzdGluZSgpO1xuICAgIGlmIChjb250cm9sLmRpcnR5KSBvdGhlci5tYXJrQXNEaXJ0eSgpO1xuICAgIGlmIChjb250cm9sLnRvdWNoZWQpIG90aGVyLm1hcmtBc1RvdWNoZWQoKTtcbiAgICBpZiAoY29udHJvbC51bnRvdWNoZWQpIG90aGVyLm1hcmtBc1VudG91Y2hlZCgpO1xuICAgIGlmIChjb250cm9sLnBlbmRpbmcpIG90aGVyLm1hcmtBc1BlbmRpbmcoKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc3luY1ZhbHVlczxPUklHSU5fVkFMVUUgPSBhbnksIE9USEVSX1ZBTFVFID0gYW55PihcbiAgICBvcmlnaW46IFVudHlwZWRGb3JtQ29udHJvbCxcbiAgICBmcm9tT3JpZ2luOiAodmFsdWVGcm9tT3JpZ2luOiBPUklHSU5fVkFMVUUpID0+IE9USEVSX1ZBTFVFLFxuICAgIGZyb21PdGhlcnM6IG51bGwgfCAoKHZhbHVlRnJvbU90aGVyOiBPVEhFUl9WQUxVRSkgPT4gT1JJR0lOX1ZBTFVFKSxcbiAgICAuLi5vdGhlcnM6IFVudHlwZWRGb3JtQ29udHJvbFtdXG4gICk6IE9ic2VydmFibGU8T1JJR0lOX1ZBTFVFPiB7XG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgdGltZXIoMCkucGlwZShcbiAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgbWFwKCgpID0+IHRoaXMuZ2V0VmFsdWUob3JpZ2luKSBhcyBPUklHSU5fVkFMVUUpLFxuICAgICAgICB0YXAoKHZhbHVlRnJvbU9yaWdpbjogT1JJR0lOX1ZBTFVFKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBmcm9tT3JpZ2luKHZhbHVlRnJvbU9yaWdpbik7XG4gICAgICAgICAgb3RoZXJzLmZvckVhY2goY29udHJvbCA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldFZhbHVlKGNvbnRyb2wsIHZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuc3luY0NvbnRyb2xWaXN1YWxTdGF0ZXMob3JpZ2luLCBjb250cm9sKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICB0aGlzLmdldFZhbHVlJChvcmlnaW4pLnBpcGUoXG4gICAgICAgIGZpbHRlcigoKSA9PiBCb29sZWFuKGZyb21PcmlnaW4pKSxcbiAgICAgICAgdGFwKCh2YWx1ZUZyb21PcmlnaW46IE9SSUdJTl9WQUxVRSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gZnJvbU9yaWdpbih2YWx1ZUZyb21PcmlnaW4pO1xuICAgICAgICAgIG90aGVycy5mb3JFYWNoKGNvbnRyb2wgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShjb250cm9sLCB2YWx1ZSk7XG4gICAgICAgICAgICB0aGlzLnN5bmNDb250cm9sVmlzdWFsU3RhdGVzKG9yaWdpbiwgY29udHJvbCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgZnJvbU90aGVyc1xuICAgICAgICA/IG1lcmdlKC4uLm90aGVycy5tYXAoY29udHJvbCA9PiB0aGlzLmdldFZhbHVlJChjb250cm9sKSkpLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKCkgPT4gQm9vbGVhbihmcm9tT3RoZXJzKSksXG4gICAgICAgICAgICB0YXAoKHZhbHVlRnJvbU90aGVyOiBPVEhFUl9WQUxVRSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGZyb21PdGhlcnModmFsdWVGcm9tT3RoZXIpO1xuICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKG9yaWdpbiwgdmFsdWUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIDogRU1QVFlcbiAgICApLnBpcGUobWFwKCgpID0+IHRoaXMuZ2V0VmFsdWUob3JpZ2luKSkpO1xuICB9XG59XG4iXX0=