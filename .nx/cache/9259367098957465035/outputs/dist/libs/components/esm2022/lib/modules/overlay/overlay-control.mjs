import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Inject, Injector, } from '@angular/core';
import { animationFrameScheduler, fromEvent, merge as mergeObs, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, filter, map, observeOn, skipWhile, startWith, takeUntil, tap, } from 'rxjs/operators';
import { PrizmOverlayComponent } from './overlay.component';
import { BODY_ELEMENT, EventBus, getContent } from './utils';
import { WINDOW } from '@ng-web-apis/common';
import { raceEmit } from '@prizm-ui/helpers';
export let PrizmOverlayControl = class PrizmOverlayControl {
    constructor(appRef, compResolver, injector, window) {
        this.appRef = appRef;
        this.compResolver = compResolver;
        this.injector = injector;
        this.window = window;
        this.zIndex = 9999;
        this.updateTextContent = new Subject();
        this.isOpen = false;
        this.destroy$ = new Subject();
        this.updateTextContent.pipe(takeUntil(this.destroy$)).subscribe(content => {
            if (this.isOpen)
                this.comp?.updateTextContent(content);
        });
    }
    open() {
        if (this.isOpen)
            return;
        this.destroy$.next();
        this.attach();
        if (this.viewEl) {
            mergeObs(this.onDocumentClick(), this.onWindowResize(), this.onEscClick())
                .pipe(takeUntil(this.destroy$))
                .subscribe();
            setTimeout(() => EventBus.send(this.zid, 'z_dynpos'), 1);
        }
        EventBus.send(this.zid, 'z_open');
        this.isOpen = true;
    }
    close() {
        if (!this.isOpen)
            return;
        this.detach();
        this.destroy$.next();
        EventBus.send(this.zid, 'z_close');
        this.isOpen = false;
    }
    toggle() {
        return this.isOpen ? this.close() : this.open();
    }
    onEscClick() {
        return fromEvent(BODY_ELEMENT, 'keydown').pipe(takeUntil(this.destroy$), skipWhile(() => !this.config.closeOnEsc), filter((e) => (e.key === 'Escape' || e.key === 'Esc' || e.keyCode === 27) &&
            e.target.nodeName === 'BODY'), tap(e => e.preventDefault()), map(e => e.target), tap(() => this.close()));
    }
    onDocumentClick() {
        const insideClick = fromEvent(this.viewEl?.querySelector('.z-overlay-wrapper'), 'click').pipe(
        // first init for block closing
        startWith(null));
        const outsideClick = fromEvent(document.body, 'click');
        return raceEmit(100, insideClick.pipe(map((e) => [e, false])), outsideClick.pipe(map((e) => [e, true]))).pipe(filter(([, isOutsideClick]) => isOutsideClick), map(([e]) => e.target), skipWhile(() => !this.config.closeOnDocClick), tap(() => {
            this.config.docClickCallback();
            this.close();
        }));
    }
    onWindowResize() {
        const onResize = fromEvent(window, 'resize');
        const onScroll = fromEvent(window, 'scroll', { passive: true });
        return mergeObs(onResize, onScroll).pipe(skipWhile(() => !this.config.listenWindowEvents), takeUntil(this.destroy$), debounceTime(5), observeOn(animationFrameScheduler), distinctUntilChanged(), tap(() => {
            EventBus.send(this.zid, 'z_dynpos');
            this.reCalculatePositions();
            this.config.windowResizeCallback();
        }));
    }
    changePosition(newPosition) {
        this.position = newPosition;
    }
    updatePosition(positionConfig) {
        this.position.updateConfig(positionConfig);
    }
    updateContent(content, props = {}) {
        this.content = getContent(content, { ...this.content.props, ...props });
    }
    updateParentContainer(node) {
        this.parentContainer = node instanceof HTMLElement ? node : null;
    }
    listen(eventName) {
        return EventBus.listen(this.zid, eventName);
    }
    reCalculatePositions() {
        EventBus.send(this.zid, 'z_dynpos');
    }
    isNotHostElement(el) {
        const wrapperEl = this.viewEl?.querySelector('.z-overlay-wrapper');
        return el !== wrapperEl && !wrapperEl?.contains(el);
    }
    attach() {
        /* create component */
        this.compFac = this.compResolver.resolveComponentFactory(PrizmOverlayComponent);
        this.compRef = this.compFac.create(this.injector);
        this.comp = this.compRef.instance;
        /* assign props */
        const { position, content, config, zid, zIndex, parentContainer } = this;
        content.props.close = this.close.bind(this);
        Object.assign(this.comp, { position, content, config, zid: zid, zIndex: zIndex, parentContainer });
        /* attach view */
        this.hostView = this.compRef.hostView;
        this.appRef.attachView(this.hostView);
        this.viewEl = this.hostView.rootNodes[0];
        (parentContainer ?? BODY_ELEMENT).appendChild(this.viewEl);
    }
    detach() {
        if (!this.hostView)
            return;
        this.appRef.detachView(this.hostView);
        this.compRef.destroy();
        this.hostView = this.viewEl = this.comp = null;
    }
};
PrizmOverlayControl = __decorate([
    __param(3, Inject(WINDOW)),
    __metadata("design:paramtypes", [ApplicationRef,
        ComponentFactoryResolver,
        Injector,
        Window])
], PrizmOverlayControl);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS1jb250cm9sLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9jb21wb25lbnRzL3NyYy9saWIvbW9kdWxlcy9vdmVybGF5L292ZXJsYXktY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLGNBQWMsRUFFZCx3QkFBd0IsRUFFeEIsTUFBTSxFQUNOLFFBQVEsR0FFVCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLEtBQUssSUFBSSxRQUFRLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xHLE9BQU8sRUFDTCxZQUFZLEVBRVosb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixHQUFHLEVBQ0gsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDO0FBVXhCLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTdDLFdBQWEsbUJBQW1CLEdBQWhDLE1BQWEsbUJBQW1CO0lBaUI5QixZQUNVLE1BQXNCLEVBQ3RCLFlBQXNDLEVBQ3RDLFFBQWtCLEVBQ1YsTUFBK0I7UUFIdkMsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFDdEIsaUJBQVksR0FBWixZQUFZLENBQTBCO1FBQ3RDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDTyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBaEJqRCxXQUFNLEdBQUcsSUFBSSxDQUFDO1FBRWQsc0JBQWlCLEdBQW9CLElBQUksT0FBTyxF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QUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsTUFBTSxHQUFJLElBQUksQ0FBQyxRQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxDQUFDLGVBQWUsSUFBSyxZQUE0QixDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFhLENBQUMsQ0FBQztJQUNyRixDQUFDO0lBRU8sTUFBTTtRQUNaLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUTtZQUFFLE9BQU87UUFFM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ2pELENBQUM7Q0FDRixDQUFBO0FBeEtZLG1CQUFtQjtJQXFCM0IsV0FBQSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7cUNBSEMsY0FBYztRQUNSLHdCQUF3QjtRQUM1QixRQUFRO1FBQ2UsTUFBTTtHQXJCdEMsbUJBQW1CLENBd0svQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFwcGxpY2F0aW9uUmVmLFxuICBDb21wb25lbnRGYWN0b3J5LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgSW5qZWN0LFxuICBJbmplY3RvcixcbiAgVmlld1JlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBhbmltYXRpb25GcmFtZVNjaGVkdWxlciwgZnJvbUV2ZW50LCBtZXJnZSBhcyBtZXJnZU9icywgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGVib3VuY2VUaW1lLFxuICBkZWxheSxcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBvYnNlcnZlT24sXG4gIHNraXBXaGlsZSxcbiAgc3RhcnRXaXRoLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgUHJpem1PdmVybGF5Q29uZmlnLFxuICBQcml6bU92ZXJsYXlDb250ZW50LFxuICBQcml6bU92ZXJsYXlDb250ZW50RGF0YSxcbiAgUHJpem1PdmVybGF5Q29udGVudFByb3BzLFxuICBQcml6bU92ZXJsYXlFdmVudE5hbWUsXG4gIFByaXptT3ZlcmxheUlkLFxufSBmcm9tICcuL21vZGVscyc7XG5pbXBvcnQgeyBQcml6bU92ZXJsYXlBYnN0cmFjdFBvc2l0aW9uIH0gZnJvbSAnLi9wb3NpdGlvbi9wb3NpdGlvbic7XG5pbXBvcnQgeyBQcml6bU92ZXJsYXlDb21wb25lbnQgfSBmcm9tICcuL292ZXJsYXkuY29tcG9uZW50JztcbmltcG9ydCB7IEJPRFlfRUxFTUVOVCwgRXZlbnRCdXMsIGdldENvbnRlbnQgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IFdJTkRPVyB9IGZyb20gJ0BuZy13ZWItYXBpcy9jb21tb24nO1xuaW1wb3J0IHsgcmFjZUVtaXQgfSBmcm9tICdAcHJpem0tdWkvaGVscGVycyc7XG5cbmV4cG9ydCBjbGFzcyBQcml6bU92ZXJsYXlDb250cm9sIHtcbiAgcG9zaXRpb24hOiBQcml6bU92ZXJsYXlBYnN0cmFjdFBvc2l0aW9uO1xuICByZWFkb25seSBjb25maWchOiBQcml6bU92ZXJsYXlDb25maWc7XG4gIGNvbnRlbnQhOiBQcml6bU92ZXJsYXlDb250ZW50O1xuICB6aWQhOiBQcml6bU92ZXJsYXlJZDtcbiAgekluZGV4ID0gOTk5OTtcbiAgY29tcCE6IFByaXptT3ZlcmxheUNvbXBvbmVudCB8IG51bGw7XG4gIHVwZGF0ZVRleHRDb250ZW50OiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdCgpO1xuICBob3N0VmlldyE6IFZpZXdSZWYgfCBudWxsO1xuICBwYXJlbnRDb250YWluZXIhOiBIVE1MRWxlbWVudCB8IG51bGw7XG4gIGNvbXBSZWYhOiBDb21wb25lbnRSZWY8UHJpem1PdmVybGF5Q29tcG9uZW50PjtcblxuICBwdWJsaWMgdmlld0VsITogSFRNTEVsZW1lbnQgfCBudWxsO1xuICBpc09wZW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBjb21wRmFjITogQ29tcG9uZW50RmFjdG9yeTxQcml6bU92ZXJsYXlDb21wb25lbnQ+O1xuICBwcml2YXRlIGRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgcHJpdmF0ZSBjb21wUmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBASW5qZWN0KFdJTkRPVykgcHJpdmF0ZSByZWFkb25seSB3aW5kb3c6IFdpbmRvd1xuICApIHtcbiAgICB0aGlzLnVwZGF0ZVRleHRDb250ZW50LnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKS5zdWJzY3JpYmUoY29udGVudCA9PiB7XG4gICAgICBpZiAodGhpcy5pc09wZW4pIHRoaXMuY29tcD8udXBkYXRlVGV4dENvbnRlbnQoY29udGVudCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgb3BlbigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc09wZW4pIHJldHVybjtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcblxuICAgIHRoaXMuYXR0YWNoKCk7XG4gICAgaWYgKHRoaXMudmlld0VsKSB7XG4gICAgICBtZXJnZU9icyh0aGlzLm9uRG9jdW1lbnRDbGljaygpLCB0aGlzLm9uV2luZG93UmVzaXplKCksIHRoaXMub25Fc2NDbGljaygpKVxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gRXZlbnRCdXMuc2VuZCh0aGlzLnppZCwgJ3pfZHlucG9zJyksIDEpO1xuICAgIH1cblxuICAgIEV2ZW50QnVzLnNlbmQodGhpcy56aWQsICd6X29wZW4nKTtcbiAgICB0aGlzLmlzT3BlbiA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgY2xvc2UoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlzT3BlbikgcmV0dXJuO1xuXG4gICAgdGhpcy5kZXRhY2goKTtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICBFdmVudEJ1cy5zZW5kKHRoaXMuemlkLCAnel9jbG9zZScpO1xuICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlKCk6IHZvaWQge1xuICAgIHJldHVybiB0aGlzLmlzT3BlbiA/IHRoaXMuY2xvc2UoKSA6IHRoaXMub3BlbigpO1xuICB9XG5cbiAgcHVibGljIG9uRXNjQ2xpY2soKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gZnJvbUV2ZW50PEtleWJvYXJkRXZlbnQ+KEJPRFlfRUxFTUVOVCBhcyBhbnksICdrZXlkb3duJykucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSxcbiAgICAgIHNraXBXaGlsZSgoKSA9PiAhdGhpcy5jb25maWcuY2xvc2VPbkVzYyksXG4gICAgICBmaWx0ZXIoXG4gICAgICAgIChlOiBLZXlib2FyZEV2ZW50KSA9PlxuICAgICAgICAgIChlLmtleSA9PT0gJ0VzY2FwZScgfHwgZS5rZXkgPT09ICdFc2MnIHx8IGUua2V5Q29kZSA9PT0gMjcpICYmXG4gICAgICAgICAgKGUudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5ub2RlTmFtZSA9PT0gJ0JPRFknXG4gICAgICApLFxuICAgICAgdGFwKGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKSxcbiAgICAgIG1hcChlID0+IGUudGFyZ2V0KSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNsb3NlKCkpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkRvY3VtZW50Q2xpY2soKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBpbnNpZGVDbGljayA9IGZyb21FdmVudDxNb3VzZUV2ZW50PihcbiAgICAgIHRoaXMudmlld0VsPy5xdWVyeVNlbGVjdG9yKCcuei1vdmVybGF5LXdyYXBwZXInKSBhcyBhbnksXG4gICAgICAnY2xpY2snXG4gICAgKS5waXBlKFxuICAgICAgLy8gZmlyc3QgaW5pdCBmb3IgYmxvY2sgY2xvc2luZ1xuICAgICAgc3RhcnRXaXRoKG51bGwgYXMgYW55KVxuICAgICk7XG4gICAgY29uc3Qgb3V0c2lkZUNsaWNrID0gZnJvbUV2ZW50PE1vdXNlRXZlbnQ+KGRvY3VtZW50LmJvZHkgYXMgYW55LCAnY2xpY2snKTtcblxuICAgIHJldHVybiByYWNlRW1pdDxbTW91c2VFdmVudCwgYm9vbGVhbl0+KFxuICAgICAgMTAwLFxuICAgICAgaW5zaWRlQ2xpY2sucGlwZShtYXAoKGU6IE1vdXNlRXZlbnQpID0+IFtlLCBmYWxzZV0pKSxcbiAgICAgIG91dHNpZGVDbGljay5waXBlKG1hcCgoZTogTW91c2VFdmVudCkgPT4gW2UsIHRydWVdKSlcbiAgICApLnBpcGUoXG4gICAgICBmaWx0ZXIoKFssIGlzT3V0c2lkZUNsaWNrXSkgPT4gaXNPdXRzaWRlQ2xpY2spLFxuICAgICAgbWFwKChbZV06IFtNb3VzZUV2ZW50LCBib29sZWFuXSkgPT4gZS50YXJnZXQpLFxuICAgICAgc2tpcFdoaWxlKCgpID0+ICF0aGlzLmNvbmZpZy5jbG9zZU9uRG9jQ2xpY2spLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5jb25maWcuZG9jQ2xpY2tDYWxsYmFjaygpO1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgb25XaW5kb3dSZXNpemUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBvblJlc2l6ZSA9IGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnKTtcbiAgICBjb25zdCBvblNjcm9sbCA9IGZyb21FdmVudCh3aW5kb3csICdzY3JvbGwnLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gICAgcmV0dXJuIG1lcmdlT2JzKG9uUmVzaXplLCBvblNjcm9sbCkucGlwZShcbiAgICAgIHNraXBXaGlsZSgoKSA9PiAhdGhpcy5jb25maWcubGlzdGVuV2luZG93RXZlbnRzKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSxcbiAgICAgIGRlYm91bmNlVGltZSg1KSxcbiAgICAgIG9ic2VydmVPbihhbmltYXRpb25GcmFtZVNjaGVkdWxlciksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgRXZlbnRCdXMuc2VuZCh0aGlzLnppZCwgJ3pfZHlucG9zJyk7XG4gICAgICAgIHRoaXMucmVDYWxjdWxhdGVQb3NpdGlvbnMoKTtcbiAgICAgICAgdGhpcy5jb25maWcud2luZG93UmVzaXplQ2FsbGJhY2soKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjaGFuZ2VQb3NpdGlvbihuZXdQb3NpdGlvbjogUHJpem1PdmVybGF5QWJzdHJhY3RQb3NpdGlvbik6IHZvaWQge1xuICAgIHRoaXMucG9zaXRpb24gPSBuZXdQb3NpdGlvbjtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVQb3NpdGlvbihwb3NpdGlvbkNvbmZpZzogUHJpem1PdmVybGF5QWJzdHJhY3RQb3NpdGlvbik6IHZvaWQge1xuICAgIHRoaXMucG9zaXRpb24udXBkYXRlQ29uZmlnKHBvc2l0aW9uQ29uZmlnKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVDb250ZW50KGNvbnRlbnQ6IFByaXptT3ZlcmxheUNvbnRlbnREYXRhLCBwcm9wczogUHJpem1PdmVybGF5Q29udGVudFByb3BzID0ge30pOiB2b2lkIHtcbiAgICB0aGlzLmNvbnRlbnQgPSBnZXRDb250ZW50KGNvbnRlbnQsIHsgLi4udGhpcy5jb250ZW50LnByb3BzLCAuLi5wcm9wcyB9KTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVQYXJlbnRDb250YWluZXIobm9kZTogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICB0aGlzLnBhcmVudENvbnRhaW5lciA9IG5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG5vZGUgOiBudWxsO1xuICB9XG5cbiAgcHVibGljIGxpc3RlbjxUID0gYW55PihldmVudE5hbWU6IFByaXptT3ZlcmxheUV2ZW50TmFtZSk6IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiBFdmVudEJ1cy5saXN0ZW4odGhpcy56aWQsIGV2ZW50TmFtZSk7XG4gIH1cblxuICBwdWJsaWMgcmVDYWxjdWxhdGVQb3NpdGlvbnMoKTogdm9pZCB7XG4gICAgRXZlbnRCdXMuc2VuZCh0aGlzLnppZCwgJ3pfZHlucG9zJyk7XG4gIH1cblxuICBwcml2YXRlIGlzTm90SG9zdEVsZW1lbnQoZWw6IEhUTUxFbGVtZW50KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgd3JhcHBlckVsID0gdGhpcy52aWV3RWw/LnF1ZXJ5U2VsZWN0b3IoJy56LW92ZXJsYXktd3JhcHBlcicpO1xuICAgIHJldHVybiBlbCAhPT0gd3JhcHBlckVsICYmICF3cmFwcGVyRWw/LmNvbnRhaW5zKGVsKTtcbiAgfVxuXG4gIHByaXZhdGUgYXR0YWNoKCk6IHZvaWQge1xuICAgIC8qIGNyZWF0ZSBjb21wb25lbnQgKi9cbiAgICB0aGlzLmNvbXBGYWMgPSB0aGlzLmNvbXBSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShQcml6bU92ZXJsYXlDb21wb25lbnQpO1xuICAgIHRoaXMuY29tcFJlZiA9IHRoaXMuY29tcEZhYy5jcmVhdGUodGhpcy5pbmplY3Rvcik7XG4gICAgdGhpcy5jb21wID0gdGhpcy5jb21wUmVmLmluc3RhbmNlO1xuXG4gICAgLyogYXNzaWduIHByb3BzICovXG4gICAgY29uc3QgeyBwb3NpdGlvbiwgY29udGVudCwgY29uZmlnLCB6aWQsIHpJbmRleCwgcGFyZW50Q29udGFpbmVyIH0gPSB0aGlzO1xuICAgIGNvbnRlbnQucHJvcHMuY2xvc2UgPSB0aGlzLmNsb3NlLmJpbmQodGhpcyk7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLmNvbXAsIHsgcG9zaXRpb24sIGNvbnRlbnQsIGNvbmZpZywgemlkOiB6aWQsIHpJbmRleDogekluZGV4LCBwYXJlbnRDb250YWluZXIgfSk7XG5cbiAgICAvKiBhdHRhY2ggdmlldyAqL1xuICAgIHRoaXMuaG9zdFZpZXcgPSB0aGlzLmNvbXBSZWYuaG9zdFZpZXc7XG4gICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyh0aGlzLmhvc3RWaWV3KTtcbiAgICB0aGlzLnZpZXdFbCA9ICh0aGlzLmhvc3RWaWV3IGFzIGFueSkucm9vdE5vZGVzWzBdO1xuICAgIChwYXJlbnRDb250YWluZXIgPz8gKEJPRFlfRUxFTUVOVCBhcyBIVE1MRWxlbWVudCkpLmFwcGVuZENoaWxkKHRoaXMudmlld0VsIGFzIGFueSk7XG4gIH1cblxuICBwcml2YXRlIGRldGFjaCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaG9zdFZpZXcpIHJldHVybjtcblxuICAgIHRoaXMuYXBwUmVmLmRldGFjaFZpZXcodGhpcy5ob3N0Vmlldyk7XG4gICAgdGhpcy5jb21wUmVmLmRlc3Ryb3koKTtcbiAgICB0aGlzLmhvc3RWaWV3ID0gdGhpcy52aWV3RWwgPSB0aGlzLmNvbXAgPSBudWxsO1xuICB9XG59XG4iXX0=